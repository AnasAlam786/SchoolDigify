{% extends "base.html" %}
{% block title %}Attendance Management{% endblock %}
{% block content %}
<style>
    .present-option.selected {
        background-image: linear-gradient(to bottom right, #22c55e, #10b981);
        /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .absent-option.selected {
        background-image: linear-gradient(to bottom right, #ef4444, #ef4444);
        /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .halfDay-option.selected {
        background-image: linear-gradient(to bottom right, #f59e0b, #f59e0b);
        /* green example */
        color: rgb(255, 255, 255);
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .attendance-option.loading-active {
        opacity: 0.8;
        transition: opacity 0.2s ease-in-out;
    }

    .loader-spin {
        animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .stat-card {
        transition: all 0.3s ease;
        background-color: #2D2D2D;
        border: 1px solid #404040;
    }

    .stat-card:hover {
        transform: translateY(-3px);
    }

    .progress-bar {
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
        background-color: #404040;
    }

    .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.8s ease-in-out;
    }

    /* Custom colors */
    .bg-primary {
        background-color: #6366F1;
    }

    .bg-success {
        background-color: #10B981;
    }

    .bg-danger {
        background-color: #EF4444;
    }

    .bg-warning {
        background-color: #F59E0B;
    }

    .bg-neutral {
        background-color: #6B7280;
    }

    .text-primary {
        color: #6366F1;
    }

    .text-success {
        color: #10B981;
    }

    .text-danger {
        color: #EF4444;
    }

    .text-warning {
        color: #F59E0B;
    }

    .text-neutral {
        color: #6B7280;
    }

    .bg-primary-opacity {
        background-color: rgba(99, 102, 241, 0.2);
    }

    .bg-success-opacity {
        background-color: rgba(16, 185, 129, 0.2);
    }

    .bg-danger-opacity {
        background-color: rgba(239, 68, 68, 0.2);
    }

    .bg-warning-opacity {
        background-color: rgba(245, 158, 11, 0.2);
    }

    .bg-neutral-opacity {
        background-color: rgba(107, 114, 128, 0.2);
    }

    .border-primary {
        border-color: rgba(99, 102, 241, 0.3);
    }

    /* Mobile-first adjustments for the holiday modal */
    @media (max-width: 480px) {
        #holidayModal .rounded-2xl {
            border-radius: 14px;
        }

        #holidayModal h3 {
            font-size: 1.05rem;
        }

        #holidayModal input,
        #holidayModal select,
        #holidayModal button {
            font-size: 0.95rem;
        }

        #holidayModal .flex-col {
            gap: 8px;
        }
    }
</style>

<!-- Main Container -->
<div class="mx-auto">

    <!-- Page Header -->
    <header class="mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                    Attendance Management System
                </h1>
                <p class="text-gray-400 mt-2 text-sm md:text-base">
                    Efficiently track and manage student attendance with a clean and modern interface
                </p>
            </div>

            <div class="flex items-center gap-3">
                {% if has_permission('mark_holiday') %}
                <button id="holidayBtn" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 
                       text-white px-5 py-2 rounded-xl font-semibold shadow-lg shadow-blue-900/20 
                       hover:shadow-blue-900/30 transition-all duration-300 flex items-center gap-2 
                       transform hover:-translate-y-0.5">
                    <i class="fas fa-plus text-white"></i>
                    Mark Holiday
                </button>
                {% endif %}

                {% if has_permission('view_holidays') %}
                <button id="viewHolidaysBtn"
                    class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-xl font-medium transition">
                    <i class="far fa-calendar-alt mr-2"></i>View Holidays
                </button>
                {% endif %}
            </div>
        </div>
    </header>
    <!-- duplicate button removed -->

    <!-- Modern Filters Section -->
    <section class="w-full mb-10 p-6 rounded-2xl shadow-2xl border border-[#2B2B2B]
                bg-gradient-to-br from-[#151515] via-[#1A1A1A] to-[#202020]">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- CLASS SELECTOR -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
                    <div class="p-2 bg-blue-500/20 rounded-lg">
                        <i class="fas fa-users text-blue-400"></i>
                    </div>
                    <span>Select Class</span>
                </label>

                <div class="relative group">
                    <select id="classSelector" class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl 
                           py-3.5 px-4 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 
                           focus:border-blue-500 transition-all duration-300 group-hover:border-gray-500">

                        {% if classes %}
                        {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.CLASS }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>

                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3">
                        <i class="fas fa-chevron-down text-gray-400 group-hover:translate-y-0.5 
                               transition-transform duration-300"></i>
                    </div>
                </div>
            </div>

            <!-- DATE SELECTOR -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
                    <div class="p-2 bg-blue-500/20 rounded-lg">
                        <i class="far fa-calendar-alt text-blue-400"></i>
                    </div>
                    <span>Select Date</span>
                </label>

                <div class="relative group">
                    <input type="date" id="dateSelector" value="{{ current_date }}" class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3.5 px-4 
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
                           transition-all duration-300 group-hover:border-gray-500 [color-scheme:dark]">
                </div>
            </div>

            <!-- GET ATTENDANCE BUTTON -->
            <div class="lg:col-span-2 mt-3 flex justify-center">
                <button id="getAttendanceDataBTN" class="w-full lg:w-1/2 bg-gradient-to-r from-purple-600 to-indigo-600 
                       hover:from-purple-700 hover:to-indigo-700 text-white font-semibold 
                       py-3.5 px-6 rounded-xl transition-all duration-300 shadow-xl 
                       shadow-purple-900/30 hover:shadow-purple-900/40 
                       flex items-center justify-center gap-3 transform hover:-translate-y-0.5 group">

                    <div class="p-1.5 bg-white/20 rounded-lg group-hover:scale-110 
                            transition-transform duration-300">
                        <i class="fas fa-calendar-plus text-white"></i>
                    </div>

                    <span>Get Attendance</span>
                </button>
            </div>

        </div>
    </section>


    <!-- Attendance Cards Section -->
    <section class="mb-10">

        <div id="studentsSummery"></div>

        <!-- Holiday / Error Alert Container -->
        <div id="attendanceAlertContainer" class="mb-6"></div>

        <div class="grid gap-4 justify-center [grid-template-columns:repeat(auto-fit,minmax(0,420px))]
                max-[480px]:grid-cols-1" id="studentsStackList"></div>
    </section>
</div>

<!-- Holiday Marking Modal -->
<div id="holidayModal" class="fixed inset-0 flex items-center justify-center z-50 hidden px-4">
    <div class="absolute inset-0 bg-black/70"></div>
    <div
        class="relative bg-[#1A1A1A] rounded-2xl p-4 sm:p-6 w-full max-w-lg mx-auto shadow-2xl border border-[#2A2A2A]">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg sm:text-xl font-semibold">Mark Holiday</h3>
            <button id="closeHolidayModal" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="holidayForm" class="space-y-4" method="POST" action="/api/add-holiday">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Holiday Name *</label>
                <input id="holidayName" name="holiday_name" type="text"
                    class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                    placeholder="e.g. Winter Break" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Date Range *</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input id="startDate" name="start_date" type="date"
                        class="flex-1 bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                        required>
                    <div class="flex items-center justify-center text-gray-400 py-2">to</div>
                    <input id="endDate" name="end_date" type="date"
                        class="flex-1 bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
                        required>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Apply To</label>
                <select id="applyTo" name="apply_to"
                    class="w-full bg-[#2A2A2A] border border-[#3A3A3A] text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                    <option selected value="">Entire School</option>
                    {% if classes %}
                    {% for class in classes %}
                    <option value="{{ class.id }}">{{ class.CLASS }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>

            <div class="pt-2">
                <button id="holidaySubmit" type="submit"
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-3.5 px-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-3">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Mark as Holiday</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Holidays List Modal -->
<div id="holidaysListModal" class="fixed inset-0 flex items-center justify-center z-50 hidden px-4">
    <div class="absolute inset-0 bg-black/70"></div>
    <div
        class="relative bg-[#1A1A1A] rounded-2xl p-4 sm:p-6 w-full max-w-3xl mx-auto shadow-2xl border border-[#2A2A2A]">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg sm:text-xl font-semibold">Marked Holidays</h3>
            <div class="flex items-center gap-2">
                <button id="closeHolidaysList" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div id="holidaysListContainer" class="space-y-3 max-h-[60vh] overflow-y-auto pb-2 text-gray-300">
            <!-- Filled by JS -->
        </div>

        <div class="mt-4 pt-4 border-t border-[#222] flex items-center justify-between">
            <div class="text-sm text-gray-400">Showing holidays added in this session</div>
            <button id="refreshHolidaysBtn"
                class="text-sm px-3 py-2 bg-white/5 rounded-lg hover:bg-white/10">Refresh</button>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div id="messageModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70"></div>

    <div class="relative bg-[#1A1A1A] rounded-2xl w-full max-w-md shadow-2xl border border-[#2A2A2A]
                flex flex-col max-h-[90vh] overflow-hidden">

        <!-- Header (never scrolls) -->
        <div class="p-5 border-b border-[#2A2A2A] flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="messageStudentName">Send Message</h3>
            <button id="closeMessageModal" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Message Area (only this part scrolls) -->
        <div class="p-5 flex-1 overflow-hidden">
            <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>

            <textarea id="WatsappMessageTextArea" class="w-full h-full max-h-[50vh] bg-[#2A2A2A] border border-[#3A3A3A] text-white 
                       rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all 
                       resize-none overflow-y-auto" placeholder="Type your message here..."></textarea>
        </div>

        <!-- Footer (never scrolls) -->
        <div class="p-5 border-t border-[#2A2A2A]">
            <button id="sendWhatsAppBTN" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 
                       text-white font-medium py-3.5 px-4 rounded-xl transition shadow-lg">
                <i class="fab fa-whatsapp mr-2"></i>Send via WhatsApp
            </button>
        </div>
    </div>
</div>

<!-- Add this modal after the existing modals (before the scripts) -->
<!-- Absent Students List Modal -->
<div id="absentListModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70"></div>

    <div class="relative bg-[#1A1A1A] rounded-2xl w-full max-w-4xl shadow-2xl border border-[#2A2A2A]
                flex flex-col max-h-[90vh] overflow-hidden">

        <!-- Header -->
        <div class="p-5 border-b border-[#2A2A2A] flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-white">Absent Students List</h3>
                <p class="text-sm text-gray-400 mt-1" id="absentListDate">Date: Loading...</p>
            </div>
            <button id="closeAbsentListModal" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-hidden flex flex-col">
            <!-- Textarea Container -->
            <div class="flex-1 overflow-hidden p-5">
                <!-- Update the buttons in your modal HTML -->
                <div class="flex items-center justify-between mb-3">
                    <label class="block text-sm font-medium text-gray-300">Premium Absent Report</label>
                    <div class="flex items-center gap-2">
                        <button id="formatListBtn" 
                                class="px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 
                                    text-white rounded-lg text-sm transition-all duration-300 shadow-lg shadow-purple-500/20 
                                    hover:shadow-purple-500/30 flex items-center">
                            <i class="fas fa-palette mr-1"></i> Format
                        </button>
                        <button id="clearListBtn" 
                                class="px-3 py-1.5 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 
                                    text-white rounded-lg text-sm transition-all duration-300 shadow-lg shadow-gray-700/20 
                                    hover:shadow-gray-700/30 flex items-center">
                            <i class="fas fa-eraser mr-1"></i> Clear
                        </button>
                    </div>
                </div>

                <textarea id="absentStudentsTextArea" 
                    class="w-full h-full min-h-[300px] bg-[#2A2A2A] border border-[#3A3A3A] text-white 
                           rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all 
                           resize-none overflow-y-auto font-mono text-sm"
                    placeholder="Loading absent students list..."></textarea>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-5 border-t border-[#2A2A2A] flex flex-col sm:flex-row gap-3">
            <button id="copyAbsentListBtn" 
                class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 
                       text-white font-medium py-3.5 px-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                <i class="far fa-copy"></i>
                <span>Copy to Clipboard</span>
            </button>
            <button id="refreshAbsentListBtn" 
                class="flex-1 bg-white/5 hover:bg-white/10 text-white font-medium py-3.5 px-4 rounded-xl transition 
                       flex items-center justify-center gap-2">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh List</span>
            </button>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='watsappMessage.js') }}"></script>
<script>
    // =====================================================
    // ATTENDANCE MANAGEMENT - PROFESSIONAL STRUCTURE
    // =====================================================

    /**
     * Global State Manager for Attendance
     * Maintains real-time attendance data and counts
     */
    const AttendanceState = {
        data: [],
        summary: {},
        date: null,
        classID: null,

        /**
         * Initialize state with attendance data
         */
        initialize(attendanceData, attendanceSummary, date, classID) {
            this.data = attendanceData || [];
            this.summary = attendanceSummary || {};
            this.date = date;
            this.classID = classID;
        },

        /**
         * Update attendance for a student
         * @param {string} studentID - Student session ID
         * @param {string|null} newStatus - PRESENT, ABSENT, HALF_DAY, or null (unmark)
         */
        updateAttendance(studentID, newStatus) {
            const student = this.data.find(s => s.student_session_id == studentID);
            if (!student) return;

            const oldStatus = student.attendance_status;
            student.attendance_status = newStatus;

            // Update summary counts
            this.updateSummary(oldStatus, newStatus);
        },

        /**
         * Update summary statistics
         */
        updateSummary(oldStatus, newStatus) {
            // Decrement old status count
            if (oldStatus && this.summary[oldStatus.toLowerCase()] !== undefined) {
                this.summary[oldStatus.toLowerCase()]--;
            } else if (oldStatus === null && this.summary.not_marked !== undefined) {
                this.summary.not_marked--;
            }

            // Increment new status count
            if (newStatus && this.summary[newStatus.toLowerCase()] !== undefined) {
                this.summary[newStatus.toLowerCase()]++;
            } else if (newStatus === null && this.summary.not_marked !== undefined) {
                this.summary.not_marked++;
            }
        },

        /**
         * Calculate percentage for a status
         */
        getPercentage(status) {
            if (this.summary.total === 0) return 0;
            const count = this.summary[status.toLowerCase()] || 0;
            return ((count / this.summary.total) * 100).toFixed(1);
        }
    };

    /**
     * UI Manager for Attendance Summary
     * Handles real-time updates of the summary card
     */
    const UISummary = {
        /**
         * Update the attendance summary card with real-time data
         */
        render() {
            const summaryContainer = document.getElementById('studentsSummery');
            const summary = AttendanceState.summary;
            const total = summary.total || 0;

            const present = summary.present || 0;
            const absent = summary.absent || 0;
            const halfDay = summary.half_day || 0;
            const notMarked = summary.not_marked || 0;

            const presentPct = ((present / total) * 100).toFixed(1);
            const absentPct = ((absent / total) * 100).toFixed(1);
            const halfDayPct = ((halfDay / total) * 100).toFixed(1);
            const notMarkedPct = ((notMarked / total) * 100).toFixed(1);

            const html = `
            <div class="attendance-card rounded-2xl p-4 md:p-6 mb-6 bg-[#1C1C1C]">
                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Class Attendance</h1>
                    <p class="text-gray-400 mt-1 text-sm md:text-base">Real-time attendance summary</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-opacity text-primary border border-primary">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        ${AttendanceState.summary.date}
                    </span>
                    </div>
                </div>

                <!-- Data holder (server-side values inserted into data-* attributes) -->
                <div id="attendance-data"
                    data-total="${total}"
                    data-present="${present}"
                    data-absent="${absent}"
                    data-halfday="${halfDay}"
                    data-notmarked="${notMarked}"></div>

                <!-- Two-column layout: KPI donut + compact stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Donut KPI (left card) -->
                    <div class="rounded-xl p-4 md:p-6 bg-[#101010] flex items-center justify-center">
                    <div class="w-full flex flex-col md:flex-row items-center gap-4">
                        <div class="mx-auto">
                        <!-- Donut container -->
                        <div id="donut" class="relative rounded-full" 
                            style=" width:120px;
                                    height:120px;
                                    border-radius:50%;
                                    background: conic-gradient(#10b981 ${presentPct}%, rgba(255,255,255,0.06) ${presentPct}% 100%);
                                    box-shadow: inset 0 -6px 18px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.02);">
                            <!-- outer conic background is set by JS -->
                            <div class="absolute inset-0 rounded-full flex items-center justify-center"
                                style="background: rgba(255,255,255,0.03);">
                            </div>
                            <!-- inner circle (cutout) -->
                            <div id="donut-inner" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2
                                        bg-[#0F1724] rounded-full flex flex-col items-center justify-center"
                                style="width:80px;height:80px;box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);">
                            <div id="donut-pct" class="text-white font-bold text-lg">${presentPct ?? '--'}%</div>
                            <div class="text-gray-400 text-xs">Present</div>
                            </div>
                        </div>
                        </div>

                        <div class="flex-1 text-center md:text-left">
                        <div class="text-gray-400 text-xs md:text-sm">Total Students</div>
                        <div id="total-count" class="text-white font-extrabold text-2xl md:text-3xl mt-1">${total}</div>
                        <div class="mt-3 flex flex-wrap items-center gap-3 justify-center md:justify-start">
                            <div class="flex items-center gap-2">
                            <span class="inline-block w-2 h-2 rounded-full bg-success"></span>
                            <span class="text-gray-400 text-xs">${presentPct ?? ''}% Present</span>
                            </div>
                            <div class="flex items-center gap-2">
                            <span class="inline-block w-2 h-2 rounded-full bg-danger"></span>
                            <span class="text-gray-400 text-xs">${absentPct ?? ''}% Absent</span>
                            </div>
                        </div>
                        </div>
                    </div>
                    </div>

                    <!-- Stats card (right) -->
                    <div class="rounded-xl p-4 md:p-6 bg-[#101010] flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <div>
                        <p class="text-gray-400 text-xs md:text-sm font-medium">Attendance Overview</p>
                        <h3 class="text-white font-bold text-lg md:text-xl mt-1">Quick Summary</h3>
                        </div>
                        <div class="text-gray-400 text-xs">Last updated: ${AttendanceState.summary.date}</div>
                    </div>

                    <div class="mt-4 space-y-4">
                        <!-- Present -->
                        <div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-success-opacity flex items-center justify-center">
                                <i class="fas fa-check text-success"></i>
                            </div>
                            <div>
                                <div class="text-gray-400 text-xs">Present</div>
                                <div id="present-count" class="text-white font-bold text-lg">${present}</div>
                            </div>
                            </div>
                            <div class="w-1/3">
                            <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                                <div id="present-bar" class="h-2 rounded-full bg-success" style="width:${presentPct ?? '0'}%"></div>
                            </div>
                            </div>
                        </div>
                        </div>

                        <!-- Absent -->
                        <div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-danger-opacity flex items-center justify-center">
                                <i class="fas fa-times text-danger"></i>
                            </div>
                            <div>
                                <div class="text-gray-400 text-xs">Absent</div>
                                <div id="absent-count" class="text-white font-bold text-lg cursor-pointer 
                                    transition-all text-red-400 underline active:scale-95" 
                                      onclick="AbsentListManager.openModal()">${absent}</div>
                            </div>
                            </div>
                            <div class="w-1/3">
                            <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                                <div id="absent-bar" class="h-2 rounded-full bg-danger" style="width: ${absentPct ?? '0'}%"></div>
                            </div>
                            </div>
                        </div>
                        </div>

                        <!-- Micro stats -->
                        <div class="flex gap-3 flex-wrap mt-2">
                        <div class="px-3 py-2 bg-white/5 rounded-full flex items-center gap-2 text-xs">
                            <span class="inline-block w-2 h-2 rounded-full bg-warning"></span>
                            <span id="halfday-count" class="text-gray-300">${halfDay}</span>
                            <span class="text-gray-400">Half Day</span>
                        </div>
                        <div class="px-3 py-2 bg-white/5 rounded-full flex items-center gap-2 text-xs">
                            <span class="inline-block w-2 h-2 rounded-full bg-neutral"></span>
                            <span id="notmarked-count" class="text-gray-300">${notMarked}</span>
                            <span class="text-gray-400">Not Marked</span>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>

        `;

            summaryContainer.innerHTML = html;
        }
    };

    /**
     * Absent List Manager
     * Professional and minimal absent list formatting
     */
    const AbsentListManager = {
        isOpen: false,
        currentData: null,

        /**
         * Open the absent list modal
         */
        async openModal() {
            if (!AttendanceState.classID || !AttendanceState.date) {
                showAlert(400, "Please select class and date first");
                return;
            }

            const modal = document.getElementById('absentListModal');
            this.isOpen = true;
            
            // Show loading state
            this.setLoadingState(true);
            
            // Open modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            try {
                // Fetch absent students data
                const data = await this.fetchAbsentStudents();
                this.currentData = data;
                this.renderAbsentList(data);
            } catch (error) {
                console.error('Error fetching absent students:', error);
                showAlert(500, 'Failed to load absent students list');
                this.setLoadingState(false);
            }
        },

        /**
         * Close the modal
         */
        closeModal() {
            const modal = document.getElementById('absentListModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            this.isOpen = false;
            this.currentData = null;
        },

        /**
         * Fetch absent students from backend
         */
        async fetchAbsentStudents() {
            const classID = AttendanceState.classID;
            const date = AttendanceState.date;

            if (!classID || !date) {
                throw new Error('Class and date required');
            }

            const response = await fetch(`/api/get_absent_students?classID=${classID}&date=${date}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Failed to fetch absent students');
            }

            return data;
        },

        /**
         * Render absent list in textarea
         */
        renderAbsentList(data) {
            const textarea = document.getElementById('absentStudentsTextArea');
            const absent = data.absent_students || [];
            const unmarked = data.unmarked_students || [];
            const cls = data.class_name || '';
            const date = data.date || '';
            const total = data.total_students || 0;

            let formattedList = '';

            // case: nothing to report (all present)
            if (absent.length === 0 && unmarked.length === 0) {
                formattedList = this.formatPerfectAttendance(cls, date);
            } else if (absent.length === 0 && unmarked.length > 0) {
                // no absentees, but some students not marked yet
                if (unmarked.length === total) {
                    formattedList = this.formatNoAttendanceMarked(cls, date);
                } else {
                    formattedList = this.formatOnlyUnmarked(unmarked, cls, date);
                }
            } else if (absent.length > 0 && unmarked.length === 0) {
                // normal absent list
                formattedList = this.formatTable(absent, cls, date);
            } else {
                // mix of absent and unmarked
                formattedList = this.formatCombined(absent, unmarked, cls, date);
            }

            textarea.value = formattedList;
            this.setLoadingState(false);
        },

        /**
         * Simple table format with icons
         */
        formatTable(students, className, date) {
            // keep original behaviour for absent-only lists
            let formatted = `ðŸ“‹ Absent Students List\n\n`;
            formatted += `ðŸ« Class: ${className}\n`;
            formatted += `ðŸ“… Date: ${date}\n`;

            // exact header (inner widths: 8 and 17)
            formatted += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
            formatted += `â”‚  Roll  â”‚  Student Name   â”‚\n`;
            formatted += `â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n`;

            students.forEach((student) => {
                const rollContent = student.ROLL?.toString().substring(0, 6).padEnd(6);
                const nameContent = (student.STUDENTS_NAME || '').substring(0, 15).padEnd(15);
                formatted += `â”‚ ${rollContent} â”‚ ${nameContent} â”‚\n`;
            });

            formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`;

            return formatted;
        },


        /**
         * Simple list format
         */
        formatList(students, className, date) {
            // students parameter may be absent or combined entries depending on caller
            let formatted = `ðŸ« Attendance Report for ${className}\n`;
            formatted += `ðŸ“… Date: ${date}\n\n`;

            if (!students || students.length === 0) {
                formatted += `âœ… All students present\n`;
            } else {
                // list out each entry (could be absent/unmarked)
                students.forEach((student) => {
                    let label = student._type || '';
                    if (label === 'unmarked') {
                        formatted += `â± [Unmarked] ${student.STUDENTS_NAME} (Roll: ${student.ROLL})\n`;
                    } else {
                        formatted += `${student.STUDENTS_NAME} (Roll: ${student.ROLL})\n`;
                    }
                });
            }

            return formatted;
        },

        /**
         * Compact format
         */
        formatCompact(students, className, date) {
            let formatted = `ðŸ“… ${className} - ${date}\n\n`;
            
            if (!students || students.length === 0) {
                formatted += `âœ… All students present`;
            } else {
                formatted += students.map(s => {
                    if (s._type === 'unmarked') return `â€¢ â± ${s.STUDENTS_NAME} #${s.ROLL}`;
                    return `â€¢ ${s.STUDENTS_NAME} #${s.ROLL}`;
                }).join('\n');
            }
            
            return formatted;
        },

        /**
         * Empty list format
         */
        formatEmptyList(className, date) {
            return `ðŸŽ‰ Perfect Attendance\n\n` +
                `ðŸ« ${className}\n` +
                `ðŸ“… ${date}\n\n` +
                `âœ… All students are present today.\n` +
                `ðŸ“Š 100% attendance achieved.`;
        },
        formatPerfectAttendance(className, date) {
            return this.formatEmptyList(className, date);
        },
        formatNoAttendanceMarked(className, date) {
            return `âš ï¸ No attendance has been recorded yet for this date.\n\n` +
                `ðŸ« ${className}\n` +
                `ðŸ“… ${date}\n\n` +
                `âž¤ Please mark attendance for students before viewing the absent list.`;
        },
        formatOnlyUnmarked(unmarked, className, date) {
            let formatted = `â± Students With Unmarked Attendance\n\n`;
            formatted += `ðŸ« ${className}\n`;
            formatted += `ðŸ“… ${date}\n\n`;
            unmarked.forEach((s) => {
                formatted += `â€¢ ${s.STUDENTS_NAME} (Roll: ${s.ROLL})\n`;
            });
            return formatted;
        },
        formatCombined(absent, unmarked, className, date) {
            let formatted = `ðŸ“‹ Absent & Unmarked Students\n\n`;
            formatted += `ðŸ« ${className}\n`;
            formatted += `ðŸ“… ${date}\n\n`;
            if (absent.length > 0) {
                formatted += `âŒ Absent (${absent.length})\n`;
                absent.forEach((s) => {
                    formatted += `â€¢ ${s.STUDENTS_NAME} (Roll: ${s.ROLL})\n`;
                });
                formatted += `\n`;
            }
            if (unmarked.length > 0) {
                formatted += `â± Unmarked (${unmarked.length})\n`;
                unmarked.forEach((s) => {
                    formatted += `â€¢ ${s.STUDENTS_NAME} (Roll: ${s.ROLL})\n`;
                });
            }
            return formatted;
        },

        /**
         * Copy list to clipboard
         */
        async copyToClipboard() {
            const textarea = document.getElementById('absentStudentsTextArea');
            
            try {
                await navigator.clipboard.writeText(textarea.value);
                
                // Simple success feedback
                const copyBtn = document.getElementById('copyAbsentListBtn');
                const originalHTML = copyBtn.innerHTML;
                
                copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied';
                copyBtn.classList.add('bg-green-500');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('bg-green-500');
                }, 1500);
                
            } catch (err) {
                console.error('Failed to copy:', err);
                showAlert(500, 'Failed to copy to clipboard');
            }
        },

        /**
         * Set loading state
         */
        setLoadingState(isLoading) {
            const textarea = document.getElementById('absentStudentsTextArea');
            const refreshBtn = document.getElementById('refreshAbsentListBtn');
            
            if (isLoading) {
                textarea.value = 'Loading list...';
                textarea.classList.add('opacity-50');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading';
            } else {
                textarea.classList.remove('opacity-50');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh';
            }
        },

        /**
         * Clear the textarea
         */
        clearList() {
            if (confirm('Clear the list?')) {
                document.getElementById('absentStudentsTextArea').value = '';
            }
        },

        /**
         * Toggle between formats
         */
        toggleFormat() {
            if (!this.currentData) return;
            const absent = this.currentData.absent_students || [];
            const unmarked = this.currentData.unmarked_students || [];

            const formatBtn = document.getElementById('formatListBtn');
            const formats = ['table', 'list', 'compact'];
            const formatNames = {
                'table': 'Table',
                'list': 'List',
                'compact': 'Compact'
            };
            
            const currentFormat = formatBtn.dataset.format || 'table';
            const currentIndex = formats.indexOf(currentFormat);
            const nextIndex = (currentIndex + 1) % formats.length;
            const nextFormat = formats[nextIndex];
            
            formatBtn.dataset.format = nextFormat;
            formatBtn.innerHTML = `<i class="fas fa-${nextFormat === 'table' ? 'table' : 'list'} mr-1"></i>${formatNames[nextFormat]}`;
            
            // build combined array for list/compact views
            let combined = [];
            // mark types so formatting functions can differentiate
            absent.forEach(s => combined.push({...s, _type: 'absent'}));
            unmarked.forEach(s => combined.push({...s, _type: 'unmarked'}));

            // Apply the selected format
            let formattedText = '';
            switch(nextFormat) {
                case 'list':
                    formattedText = this.formatList(combined, this.currentData.class_name, this.currentData.date);
                    break;
                case 'compact':
                    formattedText = this.formatCompact(combined, this.currentData.class_name, this.currentData.date);
                    break;
                default: // table
                    // table view only supports absentees; if there are unmarked also, use combined view
                    if (unmarked.length > 0) {
                        formattedText = this.formatCombined(absent, unmarked, this.currentData.class_name, this.currentData.date);
                    } else {
                        formattedText = this.formatTable(absent, this.currentData.class_name, this.currentData.date);
                    }
            }
            
            document.getElementById('absentStudentsTextArea').value = formattedText;
        },

        /**
         * Initialize event listeners
         */
        init() {
            const modal = document.getElementById('absentListModal');
            const closeBtn = document.getElementById('closeAbsentListModal');
            const copyBtn = document.getElementById('copyAbsentListBtn');
            const refreshBtn = document.getElementById('refreshAbsentListBtn');
            const formatBtn = document.getElementById('formatListBtn');
            const clearBtn = document.getElementById('clearListBtn');

            // Close modal
            closeBtn.addEventListener('click', () => this.closeModal());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.closeModal();
            });

            // Copy button
            copyBtn.addEventListener('click', () => this.copyToClipboard());

            // Refresh button
            refreshBtn.addEventListener('click', async () => {
                this.setLoadingState(true);
                try {
                    const data = await this.fetchAbsentStudents();
                    this.currentData = data;
                    this.renderAbsentList(data);
                    // Reset to table format
                    formatBtn.dataset.format = 'table';
                    formatBtn.innerHTML = '<i class="fas fa-table mr-1"></i>Table';
                } catch (error) {
                    console.error('Error refreshing:', error);
                    showAlert(500, 'Failed to refresh list');
                    this.setLoadingState(false);
                }
            });

            // Format button
            formatBtn.dataset.format = 'table';
            formatBtn.innerHTML = '<i class="fas fa-table mr-1"></i>Table';
            formatBtn.addEventListener('click', () => this.toggleFormat());

            // Clear button
            clearBtn.addEventListener('click', () => this.clearList());
        }
    };
        
    // Format date function (keep existing)
    function formatDateReadable(dateStr) {
        try {
            let d = new Date(dateStr);
            if (isNaN(d.getTime())) {
                const parts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
                if (parts.length === 3) {
                    if (parts[0].length === 4) d = new Date(parts[0], parts[1] - 1, parts[2]);
                    else d = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            return d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
        } catch (e) { return dateStr; }
    }

    /* Renders a modern Tailwind holiday/error alert into #attendanceAlertContainer */
    function showHolidayAlert({ title = 'Holiday', message = '', date = '', details = null }) {
        const container = document.getElementById('attendanceAlertContainer');
        const formattedDate = date ? `<div class="text-sm text-gray-300">${formatDateReadable(date)}</div>` : '';
        
        let detailsHtml = '';
        if (details) {
            if (details.info) {
                detailsHtml = `<div class="mt-3 text-sm text-gray-400 leading-relaxed">${details.info}</div>`;
            } else if (details.message && message !== details.message) {
                detailsHtml = `<div class="mt-3 text-sm text-gray-400 leading-relaxed">${details.message}</div>`;
            }
        }

        const html = `
        <div class="bg-gradient-to-r from-yellow-500/10 via-red-600/10 to-indigo-600/8 border border-white/5 rounded-2xl p-4 md:p-6 flex flex-col md:flex-row items-start md:items-center gap-4 shadow-lg">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-lg bg-red-600/10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>

            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="text-white font-semibold text-lg">${title}</div>
                        ${formattedDate}
                        <div class="text-sm text-gray-300 mt-1">${detailsHtml}</div>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="attendanceAlertViewHolidays" class="px-4 py-2 bg-white/5 hover:bg-white/10 text-white rounded-xl text-sm font-medium transition">View Holidays</button>
                    <button id="attendanceAlertDismiss" class="px-4 py-2 bg-white/3 hover:bg-white/10 text-white rounded-xl text-sm font-medium transition">Dismiss</button>
                </div>
            </div>
        </div>
        `;

        container.innerHTML = html;

        // Wire actions
        const viewBtn = document.getElementById('attendanceAlertViewHolidays');
        if (viewBtn) viewBtn.addEventListener('click', () => { const vb = document.getElementById('viewHolidaysBtn'); if (vb) vb.click(); });

        const dismissBtn = document.getElementById('attendanceAlertDismiss');
        if (dismissBtn) dismissBtn.addEventListener('click', () => clearHolidayAlert());
    }

    function clearHolidayAlert() {
        const container = document.getElementById('attendanceAlertContainer');
        if (container) container.innerHTML = '';
    }

    /**
     * Modal Manager
     * Handles all modal interactions
     */
    const ModalManager = {
        /**
         * Initialize all modal event listeners
         */
        init() {
            // Initialize absent list manager
            AbsentListManager.init();

            // Holiday Modal
            const holidayModal = document.getElementById('holidayModal');
            const closeHolidayModal = document.getElementById('closeHolidayModal');
            const holidayForm = document.getElementById('holidayForm');
            const holidaySubmit = document.getElementById('holidaySubmit');

            // Open modal from holiday button
            const holidayBtn = document.getElementById('holidayBtn');
            if (holidayBtn) {
                holidayBtn.addEventListener('click', () => {
                    // Reset form to create mode
                    holidayForm.reset();
                    holidayForm.dataset.batchId = '';
                    this.openModal(holidayModal);
                });
            }

            // View Holidays button
            const viewHolidaysBtn = document.getElementById('viewHolidaysBtn');
            const holidaysListModal = document.getElementById('holidaysListModal');
            if (viewHolidaysBtn) {
                viewHolidaysBtn.addEventListener('click', () => {
                    const loadAndShow = async () => {
                        try {
                            if (window.HolidayManager && typeof window.HolidayManager.loadAndShow === 'function') {
                                await window.HolidayManager.loadAndShow();
                            }
                        } catch (err) {
                            console.error('Failed to load holidays', err);
                        } finally {
                            this.openModal(holidaysListModal);
                        }
                    };
                    loadAndShow();
                });
            }
            if (closeHolidayModal) closeHolidayModal.addEventListener('click', () => this.closeModal(holidayModal));

            // Close modal when clicking backdrop
            if (holidayModal) holidayModal.addEventListener('click', (e) => { if (e.target === holidayModal) this.closeModal(holidayModal); });

            // Holiday form AJAX submit
            if (holidayForm) {
                holidayForm.dataset.batchId = '';

                holidayForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(holidayForm);

                    const start = formData.get('start_date');
                    const end = formData.get('end_date');
                    if (end < start) {
                        showAlert(400, 'End date must be same or after start date');
                        return;
                    }

                    if (holidaySubmit) {
                        holidaySubmit.disabled = true;
                        const originalHTML = holidaySubmit.innerHTML;
                        holidaySubmit.innerHTML = '<span class="loader-spin w-5 h-5 border-2 border-current border-t-transparent rounded-full"></span> Saving...';
                        try {
                            const batchId = holidayForm.dataset.batchId;
                            let res;
                            if (batchId) {
                                // update existing batch
                                const url = `/api/holidays/${encodeURIComponent(batchId)}`;
                                res = await fetch(url, { method: 'PUT', body: formData, credentials: 'same-origin' });
                            } else {
                                // create new
                                res = await fetch(holidayForm.action, { method: 'POST', body: formData, credentials: 'same-origin' });
                            }

                            const data = await res.json();
                            if (!res.ok) throw data;

                            showAlert(200, data.message || (batchId ? 'Holiday updated' : 'Holiday added'));
                            this.closeModal(holidayModal);
                            // refresh holidays list if visible
                            if (!holidaysListModal.classList.contains('hidden') && window.HolidayManager) await window.HolidayManager.load();
                        } catch (err) {
                            console.error('Holiday save error', err);
                            showAlert(err.status || 500, err.error || 'Failed to save holiday');
                        } finally {
                            holidaySubmit.disabled = false;
                            holidaySubmit.innerHTML = originalHTML;
                            holidayForm.dataset.batchId = '';
                        }
                    }
                });
            }

            // Message Modal
            const messageModal = document.getElementById('messageModal');
            const closeMessageModal = document.getElementById('closeMessageModal');
            closeMessageModal.addEventListener('click', () => this.closeModal(messageModal));

            // WhatsApp Button
            const sendWhatsAppBTN = document.getElementById('sendWhatsAppBTN');
            sendWhatsAppBTN.addEventListener('click', (e) => {
                e.preventDefault();
                const message = document.getElementById("WatsappMessageTextArea").value;
                const phone = sendWhatsAppBTN.getAttribute("data-phone");
                sendWhatsAppMessage(phone, message);
            });

            // Close modals on background click
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('fixed')) {
                    event.target.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            });
        },

        /**
         * Open a modal
         */
        openModal(modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        },

        /**
         * Close a modal
         */
        closeModal(modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };

    /**
     * API Manager
     * Handles all API calls
     */
    const APIManager = {
        /**
         * Fetch attendance data from server
         */
        async getAttendanceData(classID, date) {
            if (!classID || !date) {
                showAlert(400, "Class and date are required");
                return null;
            }

            const container = document.getElementById('studentsStackList');
            container.innerHTML = this.getSkeletonLoaders();

            try {
                const query = new URLSearchParams({ classID, date });
                const response = await fetch(`/api/get_attendance_data?${query}`);
                const body = await response.json();

                // If the backend indicates a holiday or Sunday, surface that explicitly
                if (body && body.holiday) {
                    return { holiday: true, message: body.message, info: body.info, details: body };
                }

                if (!response.ok) {
                    showAlert(response.status, body.message || "Failed to fetch attendance data");
                    return null;
                }

                return {
                    attendanceData: body.attendance_data || [],
                    attendanceSummary: body.attendance_summary || {}
                };
            } catch (error) {
                showAlert(500, "Network error");
                console.error("Error fetching attendance:", error);
                return null;
            }
        },

        /**
         * Send attendance marking request to server
         */
        async markAttendance(studentID, status, date) {
            try {
                const response = await fetch("/api/mark_attendance", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        student_session_id: studentID,
                        status: status,
                        date: date
                    })
                });

                const body = await response.json();

                if (!response.ok) {
                    showAlert(response.status, body.message || "Failed to mark attendance");
                    return false;
                }

                return true;
            } catch (error) {
                showAlert(500, "Network error");
                console.error("Error marking attendance:", error);
                return false;
            }
        },

        /**
         * Get absent message template
         */
        async getAbsentMessage(studentName, fathersName, className, phone, date) {
            try {
                const query = new URLSearchParams({ studentName, fathersName, className, phone, date });
                const response = await fetch(`/api/get_absent_message?${query}`);
                const body = await response.json();

                if (!response.ok) {
                    showAlert(response.status, body.message || "Failed to get message");
                    return "";
                }

                return body.absent_message || "";
            } catch (error) {
                showAlert(500, "Error fetching message template");
                return "";
            }
        },

        /**
         * Generate skeleton loaders for loading state
         */
        getSkeletonLoaders() {
            const skeleton = `
            <div class="bg-[#1C1C1C] rounded-2xl p-5 border border-[#2A2A2A] shadow-xl animate-pulse">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-xl bg-[#2A2A2A]"></div>
                        <div class="space-y-2">
                            <div class="w-32 h-4 bg-[#2A2A2A] rounded"></div>
                            <div class="w-24 h-3 bg-[#2A2A2A] rounded"></div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="w-10 h-10 rounded-xl bg-[#2A2A2A]"></div>
                        <div class="w-10 h-10 rounded-xl bg-[#2A2A2A]"></div>
                    </div>
                </div>
                <div class="flex gap-2 mb-5">
                    <div class="w-20 h-6 bg-[#2A2A2A] rounded-lg"></div>
                    <div class="w-20 h-6 bg-[#2A2A2A] rounded-lg"></div>
                </div>
                <div class="pt-4 border-t border-[#333]">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="w-full h-16 bg-[#2A2A2A] rounded-xl"></div>
                        <div class="w-full h-16 bg-[#2A2A2A] rounded-xl"></div>
                        <div class="w-full h-16 bg-[#2A2A2A] rounded-xl"></div>
                    </div>
                </div>
            </div>
        `;

            return skeleton.repeat(3);
        }
    };

    /**
     * Render Manager
     * Handles UI rendering
     */
    const RenderManager = {
        /**
         * Render attendance data
         */
        render(attendanceData, date) {
            const container = document.getElementById('studentsStackList');
            container.innerHTML = '';

            attendanceData.forEach(data => {
                const status = data.attendance_status;
                const html = this.getStudentCardHTML(data, status, date);
                container.insertAdjacentHTML("beforeend", html);
            });
        },

        /**
         * Generate student card HTML
         */
        getStudentCardHTML(data, status, date) {
            const presentSelected = status === "PRESENT" ? "selected" : "";
            const absentSelected = status === "ABSENT" ? "selected" : "";
            const halfDaySelected = status === "HALF_DAY" ? "selected" : "";

            return `
            <div class="bg-[#1C1C1C] rounded-2xl p-5 border border-[#2A2A2A] shadow-xl hover:shadow-2xl hover:border-[#3A3A3A] transition-all duration-300">
                <!-- Header -->
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-4">
                        <img src="https://lh3.googleusercontent.com/d/${data.IMAGE}=s200"
                            class="w-16 h-16 rounded-xl object-cover shadow-md"
                            loading="lazy">
                        <div>
                            <h3 class="text-lg font-semibold text-white leading-tight">${data.STUDENTS_NAME}</h3>
                            <p class="text-xs text-gray-400 leading-tight">C/O: ${data.FATHERS_NAME}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="w-10 h-10 bg-green-600/90 hover:bg-green-600 text-white rounded-xl flex items-center justify-center shadow-lg transition"
                                onclick="openMessageModal('${data.STUDENTS_NAME}','${data.FATHERS_NAME}','${data.CLASS}','${data.PHONE}','${date}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </div>

                <!-- Student Details -->
                <div class="flex gap-2 mb-5 text-sm">
                    <span class="bg-[#2A2A2A] px-3 py-1.5 rounded-lg">Class: ${data.CLASS}</span>
                    <span class="bg-[#2A2A2A] px-3 py-1.5 rounded-lg">Roll: ${data.ROLL}</span>
                </div>

                <!-- Attendance Buttons -->
                <div class="pt-4 border-t border-[#333]">
                    <div class="grid grid-cols-3 gap-3">
                        <button class="attendance-option present-option ${presentSelected} 
                            border border-green-600 text-green-500 bg-green-500/10 hover:bg-green-500/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" 
                            data-student="${data.student_session_id}"
                            onclick="AttendanceManager.markAttendance('${data.student_session_id}', 'PRESENT', '${date}', this)">
                            <i class="fas fa-check-circle text-lg"></i>
                            <span class="text-xs font-semibold">Present</span>
                        </button>

                        <button class="attendance-option absent-option ${absentSelected}
                            border border-red-600 text-red-400 bg-red-500/10 hover:bg-red-500/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" 
                            data-student="${data.student_session_id}"
                            onclick="AttendanceManager.markAttendance('${data.student_session_id}', 'ABSENT', '${date}', this)">
                            <i class="fas fa-times-circle text-lg"></i>
                            <span class="text-xs font-semibold">Absent</span>
                        </button>

                        <button class="attendance-option halfDay-option ${halfDaySelected}
                            border border-yellow-500 text-yellow-400 bg-yellow-400/10 hover:bg-yellow-400/20
                            py-3 rounded-xl flex flex-col items-center gap-1 transition" 
                            data-student="${data.student_session_id}"
                            onclick="AttendanceManager.markAttendance('${data.student_session_id}', 'HALF_DAY', '${date}', this)">
                            <i class="fas fa-clock text-lg"></i>
                            <span class="text-xs font-semibold">Half Day</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        }
    };

    /**
     * Attendance Manager
     * Main controller for attendance operations
     */
    const AttendanceManager = {
        /**
         * Mark or unmark attendance
         */
        async markAttendance(studentID, status, date, clickedButton) {
            // Validation
            if (!studentID || !status || !date) {
                showAlert(400, "Invalid attendance data");
                return;
            }

            const isAlreadySelected = clickedButton.classList.contains("selected");
            const originalHTML = clickedButton.innerHTML;
            const newStatus = isAlreadySelected ? null : status;

            // Show loading state
            this.setButtonLoading(clickedButton, true);

            try {
                // Call API
                const success = await APIManager.markAttendance(studentID, newStatus, date);

                if (!success) {
                    this.setButtonLoading(clickedButton, false);
                    clickedButton.innerHTML = originalHTML;
                    return;
                }

                // Update UI
                this.updateButtonUI(clickedButton, studentID, newStatus, isAlreadySelected);

                // Update state and summary
                AttendanceState.updateAttendance(studentID, newStatus);
                UISummary.render();

            } catch (error) {
                showAlert(500, "Error marking attendance");
                console.error(error);
            } finally {
                this.setButtonLoading(clickedButton, false);
                clickedButton.innerHTML = originalHTML;
            }
        },

        /**
         * Set button loading state
         */
        setButtonLoading(button, isLoading) {
            button.disabled = isLoading;
            button.classList.toggle("loading-active", isLoading);
            if (isLoading) {
                button.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <div class="h-5 flex items-center justify-center">
                        <span class="loader-spin w-5 h-5 border-2 border-current border-t-transparent rounded-full"></span>
                    </div>
                    <span class="text-xs font-semibold opacity-80">Marking...</span>
                </div>
            `;
            }
        },

        /**
         * Update button UI
         */
        updateButtonUI(clickedButton, studentID, newStatus, wasSelected) {
            if (wasSelected) {
                clickedButton.classList.remove("selected");
            } else {
                // Deselect all other buttons for this student
                document.querySelectorAll(`.attendance-option[data-student="${studentID}"]`).forEach(btn => {
                    btn.classList.remove("selected");
                });
                clickedButton.classList.add("selected");
            }
        }
    };

    /**
     * Message Manager
     * Handles message modal operations
     */
    const MessageManager = {
        /**
         * Open message modal
         */
        async openModal(studentName, fathersName, className, phone, date) {
            const messageModal = document.getElementById("messageModal");
            const messageTitle = document.getElementById("messageStudentName");
            const textarea = document.getElementById("WatsappMessageTextArea");
            const sendBtn = document.getElementById("sendWhatsAppBTN");

            messageTitle.textContent = `Send Message to ${studentName}`;

            // Fetch message template
            const message = await APIManager.getAbsentMessage(studentName, fathersName, className, phone, date);

            messageModal.classList.remove("hidden");
            document.body.style.overflow = 'hidden';
            textarea.value = message;

            // Auto-expand textarea
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + "px";

            // Set phone number for sending
            sendBtn.setAttribute("data-phone", phone);
        }
    };

    /**
     * Initialize Application
     */
    document.addEventListener('DOMContentLoaded', function () {
        const getAttendanceDataBTN = document.getElementById('getAttendanceDataBTN');

        // Event listener for getting attendance
        getAttendanceDataBTN.addEventListener("click", async () => {
            clearHolidayAlert();
            const classID = document.getElementById("classSelector").value;
            const date = document.getElementById("dateSelector").value;

            if (!classID) {
                showAlert(400, "Select a class");
                return;
            }
            if (!date) {
                showAlert(400, "Select a date");
                return;
            }

            // Fetch data from backend
            const result = await APIManager.getAttendanceData(classID, date);
            if (!result) return;

            // If API indicates a holiday or Sunday
            if (result.holiday) {
                showHolidayAlert({ 
                    title: result.message || 'Holiday', 
                    message: result.info || 'No classes scheduled for this date.', 
                    date: date, 
                    details: result 
                });
                document.getElementById('studentsStackList').innerHTML = '';
                document.getElementById('studentsSummery').innerHTML = '';
                return;
            }

            // Initialize state
            AttendanceState.initialize(result.attendanceData, result.attendanceSummary, date, classID);

            // Render UI
            RenderManager.render(result.attendanceData, date);
            UISummary.render();
        });

        // Initialize modals
        ModalManager.init();
    });

    /**
     * Holiday Manager
     * Loads holiday batches, renders list, supports edit/delete
     */
    const HolidayManager = {
        async load() {
            try {
                const res = await fetch('/api/holidays');
                const body = await res.json();
                if (!res.ok) { showAlert(res.status, body.error || 'Failed to load holidays'); return []; }
                return body.batches || [];
            } catch (err) { console.error(err); showAlert(500, 'Network error'); return []; }
        },

        async loadAndShow() {
            const list = await this.load();
            this.renderList(list);
        },

        renderList(batches) {
            const container = document.getElementById('holidaysListContainer');
            container.innerHTML = '';
            if (!batches || batches.length === 0) {
                container.innerHTML = '<div class="text-gray-400">No holidays found.</div>';
                return;
            }

            batches.forEach(b => {
                const classLabel = b.class_name ? `Class: ${b.class_name}` : 'Entire School';
                const datesLabel = b.start_date === b.end_date ? b.start_date : `${b.start_date} â€” ${b.end_date}`;
                const html = `
                    <div class="bg-[#1C1C1C] border border-[#2A2A2A] p-4 rounded-xl flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <div class="text-white font-semibold">${b.name}</div>
                                    <div class="text-gray-400 text-sm mt-1">${classLabel} Â· <span class="font-medium">${b.days}</span> day(s)</div>
                                </div>
                                <div class="text-gray-300 text-sm">${datesLabel}</div>
                            </div>
                            <div class="mt-3 text-xs text-gray-400">Dates: ${b.entries.map(e => e.date).join(', ')}</div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button data-batch="${b.batch_id}" class="edit-holiday-btn px-3 py-2 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white rounded-lg hover:opacity-95 text-sm">Edit</button>
                            <button data-batch="${b.batch_id}" class="delete-holiday-btn px-3 py-2 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-lg hover:opacity-95 text-sm">Delete</button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // attach handlers
            container.querySelectorAll('.edit-holiday-btn').forEach(btn => btn.addEventListener('click', (e) => this.onEditClick(e)));
            container.querySelectorAll('.delete-holiday-btn').forEach(btn => btn.addEventListener('click', (e) => this.onDeleteClick(e)));
        },

        async onEditClick(e) {
            const batchId = e.currentTarget.getAttribute('data-batch');
            if (!batchId) return;
            // fetch full batch data
            const batches = await this.load();
            const batch = batches.find(b => b.batch_id === batchId);
            if (!batch) { showAlert(404, 'Batch not found'); return; }

            // populate holidayForm for editing
            const form = document.getElementById('holidayForm');
            form.dataset.batchId = batchId;
            form.querySelector('#holidayName').value = batch.name || '';
            form.querySelector('#startDate').value = batch.start_date || '';
            form.querySelector('#endDate').value = batch.end_date || '';
            if (form.querySelector('#applyTo')) form.querySelector('#applyTo').value = batch.class_id || '';

            // close list modal and open holiday edit modal using ModalManager
            try {
                const holidaysListModal = document.getElementById('holidaysListModal');
                const holidayModal = document.getElementById('holidayModal');
                if (window.ModalManager && typeof window.ModalManager.closeModal === 'function') {
                    window.ModalManager.closeModal(holidaysListModal);
                } else if (holidaysListModal) {
                    holidaysListModal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }

                if (window.ModalManager && typeof window.ModalManager.openModal === 'function') {
                    window.ModalManager.openModal(holidayModal);
                } else if (holidayModal) {
                    holidayModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            } catch (err) {
                console.error('Error opening edit modal', err);
            }
        },

        async onDeleteClick(e) {
            const batchId = e.currentTarget.getAttribute('data-batch');
            if (!batchId) return;
            if (!confirm('Delete this holiday batch? This will remove all dates in the batch.')) return;
            try {
                const res = await fetch(`/api/holidays/${encodeURIComponent(batchId)}`, { method: 'DELETE', credentials: 'same-origin' });
                const body = await res.json();
                if (!res.ok) throw body;
                showAlert(200, body.message || 'Deleted');
                await this.loadAndShow();
            } catch (err) {
                console.error(err);
                showAlert(err.status || 500, err.error || 'Failed to delete');
            }
        }
    };
    // expose for handlers that may be wired earlier
    window.HolidayManager = HolidayManager;

    // hook up close and refresh for holidays list modal
    document.addEventListener('DOMContentLoaded', () => {
        const closeHolidaysList = document.getElementById('closeHolidaysList');
        if (closeHolidaysList) closeHolidaysList.addEventListener('click', () => { 
            document.getElementById('holidaysListModal').classList.add('hidden'); 
            document.body.style.overflow = 'auto'; 
        });
        const refreshHolidaysBtn = document.getElementById('refreshHolidaysBtn');
        if (refreshHolidaysBtn) refreshHolidaysBtn.addEventListener('click', async () => { 
            await window.HolidayManager.loadAndShow(); 
        });
    });

    /**
     * Global function wrapper for message modal (called from inline onclick)
     */
    window.openMessageModal = async function (studentName, fathersName, className, phone, date) {
        await MessageManager.openModal(studentName, fathersName, className, phone, date);
    };
</script>

{% endblock %}