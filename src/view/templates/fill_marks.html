{% extends "base.html" %}
{% block title %}Update Marks{% endblock %}
{% block content %}
<style>
  /* Custom scrollbar (kept) */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(75, 85, 99, 0.2);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #3b82f6;
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #2563eb;
  }

  /* Hide scrollbar for modal */
  .hide-scrollbar {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  /* Modal transitions */
  .modal {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .modal-hidden {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.9);
  }

  .modal-visible {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
  }

  /* Glass card effect */
  .glass-card {
    background: rgba(30, 30, 30, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  /* Premium input style */
  .premium-input {
    background: rgba(20, 20, 20, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
  }

  .premium-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    background: rgba(25, 25, 25, 0.9);
  }

  /* Animated gradient text */
  .gradient-text {
    background: linear-gradient(135deg, #a78bfa, #60a5fa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Gentle bounce animation */
  @keyframes gentle-bounce {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-8px);
    }
  }

  .animate-gentle-bounce {
    animation: gentle-bounce 2.5s infinite ease-in-out;
  }

  /* Soft pulse for the initial prompt icon */
  @keyframes soft-pulse {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.7;
    }
  }

  .animate-soft-pulse {
    animation: soft-pulse 2s infinite ease-in-out;
  }
</style>

<div class="mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header Section -->
  <div class="mb-10">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
      <!-- Left side: icon + title -->
      <div class="flex items-center gap-4">
        <div
          class="p-3 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 backdrop-blur-sm border border-white/10 shadow-xl">
          <i class="fas fa-edit text-2xl text-indigo-400"></i>
        </div>
        <div>
          <h1 class="text-3xl md:text-4xl font-bold">
            <span class="gradient-text">Marks Update</span>
          </h1>
          <p class="text-gray-400 text-sm md:text-base mt-1 max-w-2xl">
            Select class, subject & exam â€“ then enter marks seamlessly.
          </p>
        </div>
      </div>

      <!-- Manage Exams button (if permitted) -->
      {% if has_permission('lock_marks') %}
      <button type="button" id="manageExamsBtn"
        class="group flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all duration-300 text-gray-200 font-medium backdrop-blur-sm">
        <i class="fas fa-cog text-indigo-400 group-hover:rotate-90 transition-transform duration-500"></i>
        <span>Manage Exams</span>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Selection Cards -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-10">
    <!-- Class -->
    <div class="glass-card rounded-xl p-5">
      <label class="block text-sm font-semibold text-gray-300 mb-2 ml-1">
        <i class="fas fa-graduation-cap mr-2 text-indigo-400"></i>Class
      </label>
      <div class="relative">
        <select id="Class" name="selectClass" required
          class="w-full bg-[#1A1A1A] border border-white/10 text-gray-100 text-base p-3 pl-4 rounded-lg focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 outline-none transition-all appearance-none cursor-pointer">
          <option disabled selected hidden value="" class="bg-[#1A1A1A] text-gray-500">Select Class</option>
          {% if classes %}
          {% for class in classes %}
          <option value="{{ class.id }}" class="bg-[#1A1A1A] text-gray-100">{{ class.CLASS }}</option>
          {% endfor %}
          {% endif %}
        </select>
        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>

    <!-- Subject -->
    <div class="glass-card rounded-xl p-5">
      <label class="block text-sm font-semibold text-gray-300 mb-2 ml-1">
        <i class="fas fa-book mr-2 text-purple-400"></i>Subject
      </label>
      <div class="relative">
        <select id="Subject" name="selectSubject" required
          class="w-full bg-[#1A1A1A] border border-white/10 text-gray-100 text-base p-3 pl-4 rounded-lg focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 outline-none transition-all appearance-none cursor-pointer">
          <option disabled selected hidden value="" class="bg-[#1A1A1A] text-gray-500">Select Subject</option>
          {% if subjects %}
          {% for subject in subjects %}
          <option value="{{ subject.id }}" class="bg-[#1A1A1A] text-gray-100">{{ subject.subject }}</option>
          {% endfor %}
          {% endif %}
        </select>
        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>

    <!-- Exam -->
    <div class="glass-card rounded-xl p-5">
      <label class="block text-sm font-semibold text-gray-300 mb-2 ml-1">
        <i class="fas fa-clipboard-list mr-2 text-blue-400"></i>Exam
      </label>
      <div class="relative">
        <select id="Exam" name="selectExam" required
          class="w-full bg-[#1A1A1A] border border-white/10 text-gray-100 text-base p-3 pl-4 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all appearance-none cursor-pointer">
          <option disabled selected hidden value="" class="bg-[#1A1A1A] text-gray-500">Select Exam</option>
          {% if exams %}
          {% for exam in exams %}
          <option value="{{ exam.id }}" {% if (not exam.is_enabled) and (not has_permission('override_marks_lock'))
            %}disabled{% endif %} class="bg-[#1A1A1A] text-gray-100 {% if not exam.is_enabled %}opacity-50{% endif %}">
            {{ exam.exam_name }}
          </option>
          {% endfor %}
          {% endif %}
        </select>
        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Centered Get Marks button -->
  <div class="text-center mb-12">
    <button type="button" onclick="submitData()"
      class="group relative px-10 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold rounded-xl shadow-lg hover:shadow-indigo-500/30 transition-all duration-300 transform hover:-translate-y-1">
      <span class="flex items-center gap-3">
        <i class="fas fa-download"></i>
        <span>Get Marks</span>
        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
      </span>
    </button>
  </div>

  <!-- Marks Table / Cards Container -->
  <div id="marksTable" class="transition-opacity duration-300">
    {% if data is none %}
    <!-- Initial state: no selection made yet -->
    <div
      class="flex flex-col items-center justify-center py-16 px-4 text-center glass-card rounded-2xl border border-white/5">
      <div
        class="w-24 h-24 mb-6 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center animate-soft-pulse">
        <i class="fas fa-hand-pointer text-4xl text-indigo-300"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">Ready to update marks?</h3>
      <p class="text-gray-400 mb-2 max-w-md">Please select a <span class="text-indigo-400 font-semibold">class</span>,
        <span class="text-purple-400 font-semibold">subject</span>, and <span
          class="text-blue-400 font-semibold">exam</span> from the dropdowns above, then click <span
          class="text-white font-medium">Get Marks</span>.
      </p>
      <p class="text-gray-500 text-sm mt-4">We'll show the list of students once you've made your choices.</p>
    </div>
    {% elif data|length == 0 %}

    <!-- Empty State: No students found after selection -->
    <div
      class="flex flex-col items-center justify-center py-16 px-4 text-center glass-card rounded-2xl border border-white/5">
      <div
        class="w-24 h-24 mb-6 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center animate-gentle-bounce">
        <i class="fas fa-user-slash text-4xl text-indigo-300"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">No students found</h3>
      <p class="text-gray-400 mb-8 max-w-md">This class doesn't have any students yet. Add a new student to start
        recording marks.</p>
      <a href="/admission"
        class="inline-flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1">
        <i class="fas fa-plus-circle"></i>
        <span>Add Student</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>

    {% else %}


    <!-- Desktop Table (lg and up) -->
    <div class="hidden lg:block">
      <div class="glass-card rounded-2xl overflow-hidden border border-white/5">
        <div class="custom-scrollbar overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-300">
            <thead
              class="bg-gradient-to-r from-indigo-900/40 to-purple-900/40 backdrop-blur-sm border-b border-white/10">
              <tr>
                <th scope="col" class="px-6 py-4 text-xs font-semibold uppercase tracking-wider">Name</th>
                <th scope="col" class="px-6 py-4 text-xs font-semibold uppercase tracking-wider">Class</th>
                <th scope="col" class="px-6 py-4 text-xs font-semibold uppercase tracking-wider">Subject</th>
                <th scope="col" class="px-6 py-4 text-xs font-semibold uppercase tracking-wider">Roll No</th>
                <th scope="col" class="px-6 py-4 text-xs font-semibold uppercase tracking-wider">Marks</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
              {% for row in data %}
              <tr class="hover:bg-white/5 transition-colors">
                <td class="px-6 py-4 font-medium">
                  <div class="flex items-center gap-3">
                    <div
                      class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center">
                      <i class="fas fa-user text-xs text-indigo-300"></i>
                    </div>
                    <span>{{ row.STUDENTS_NAME }}</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                          {% if row.GENDER == 'Male' %}bg-blue-500/20 text-blue-300
                          {% else %}bg-pink-500/20 text-pink-300{% endif %}">
                    {{ row.CLASS }}
                  </span>
                </td>
                <td class="px-6 py-4">{{ row.subject }}</td>
                <td class="px-6 py-4 font-mono">{{ row.ROLL }}</td>
                <td class="px-6 py-4">
                  <div class="flex">
                    <input type="{{ 'text' if row.evaluation_type == 'grading' else 'number' }}"
                      placeholder="{{ row.subject }}"
                      inputmode="{{ 'text' if row.evaluation_type == 'grading' else 'number' }}" onfocus="this.select()"
                      {% if row.evaluation_type=='numeric' %} min="0" max="{{ row.weightage }}" {% endif %}
                      value="{{ '' if row.score is none else row.score }}"
                      oninput="{{ 'this.value = this.value.toUpperCase();' if row.evaluation_type == 'grading' else '' }}"
                      class="premium-input text-white rounded-l-lg focus:ring-0 block w-full p-2.5"
                      id="marks-desktop-{{ row.student_id }}">
                    <button
                      class="submit-btn px-4 {% if row.GENDER == 'Male' %}bg-blue-600 hover:bg-blue-500{% else %}bg-pink-600 hover:bg-pink-500{% endif %} text-white font-medium rounded-r-lg transition-all duration-200 hover:shadow-lg"
                      data-id="{{ row.id }}" data-evaluation_type="{{ row.evaluation_type }}"
                      data-student_id="{{ row.student_id }}" data-subject_id="{{ row.subject_id }}"
                      data-exam_id="{{ row.exam_id }}"
                      onclick="submit(this, inputID='marks-desktop-{{ row.student_id }}')">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Mobile Cards (lg:hidden) -->
    <div class="lg:hidden space-y-4">
      {% for row in data %}
      <div class="glass-card rounded-2xl p-5 border border-white/5">
        <div class="flex justify-between items-start mb-4">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center">
              <i class="fas fa-user text-indigo-300"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">{{ row.STUDENTS_NAME }}</h3>
              <p class="text-sm {% if row.GENDER == 'Male' %}text-blue-300{% else %}text-pink-300{% endif %}">
                Roll No: {{ row.ROLL }}
              </p>
            </div>
          </div>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                  {% if row.GENDER == 'Male' %}bg-blue-500/20 text-blue-300
                  {% else %}bg-pink-500/20 text-pink-300{% endif %}">
            {{ row.CLASS }}
          </span>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">Subject</p>
            <p class="text-white font-medium">{{ row.subject }}</p>
          </div>
          <div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">Exam</p>
            <p class="text-white font-medium">{{ row.exam_name }}</p>
          </div>
        </div>

        <div class="mb-3">
          <p class="text-gray-400 text-xs uppercase tracking-wider mb-2">Marks (0-{{ row.weightage }})</p>
          <input type="{{ 'text' if row.evaluation_type == 'grading' else 'number' }}" placeholder="Enter marks"
            inputmode="{{ 'text' if row.evaluation_type == 'grading' else 'number' }}" onfocus="this.select()" {% if
            row.evaluation_type=='numeric' %} min="0" max="{{ row.weightage }}" {% endif %}
            oninput="{{ 'this.value = this.value.toUpperCase();' if row.evaluation_type == 'grading' else '' }}"
            value="{{ '' if row.score is none else row.score }}" class="premium-input text-white rounded-lg w-full p-3"
            id="marks-mobile-{{ row.student_id }}">
        </div>

        <button onclick="submit(this, inputID='marks-mobile-{{ row.student_id }}')" data-id="{{ row.id }}"
          data-evaluation_type="{{ row.evaluation_type }}" data-student_id="{{ row.student_id }}"
          data-subject_id="{{ row.subject_id }}" data-exam_id="{{ row.exam_id }}"
          class="submit-btn w-full {% if row.GENDER == 'Male' %}bg-blue-600 hover:bg-blue-500{% else %}bg-pink-600 hover:bg-pink-500{% endif %} text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 hover:shadow-lg">
          <i class="fas fa-paper-plane"></i>
          <span>Submit</span>
        </button>
      </div>
      {% endfor %}
    </div>

    {% endif %}
  </div>
</div>

<!-- Manage Exams Modal -->
<div id="manageExamsModal"
  class="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity z-50 flex items-center justify-center p-4 modal-hidden">
  <div class="glass-card w-full max-w-md rounded-2xl border border-white/10 shadow-2xl">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-white/10">
      <h2 class="text-xl font-semibold text-white">Manage Exams</h2>
      <button id="closeModalBtn" class="closeModalBtn text-gray-400 hover:text-white transition text-2xl leading-none">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Body -->
    <div class="px-6 py-4">


      <!-- Exams list (loaded dynamically) -->
      <div id="examsList" class="max-h-[360px] overflow-y-auto custom-scrollbar space-y-3">
        <!-- Loaded dynamically -->
      </div>
    </div>

    <!-- Info message: exam disabled behavior -->
    <div
      class="mb-4 p-3 m-3 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-300 text-sm flex items-start gap-3">
      <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
      <span>
        <span class="font-semibold">Note:</span> After disabling an exam, you can still update marks.
        However, teachers and other staff will not be able to fill or modify marks.
      </span>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-white/10 flex justify-end">
      <button class="closeModalBtn px-5 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 transition">
        Close
      </button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='fill_marks.js') }}"></script>
<script>
  function showSkeleton() {
    const container = document.getElementById('marksTable');
    if (!container) return;
    container.innerHTML = `
      <div class="space-y-6" aria-busy="true">
        <!-- Desktop skeleton -->
        <div class="hidden lg:block glass-card rounded-2xl p-5">
          <div class="animate-pulse space-y-4">
            <div class="h-8 bg-white/5 rounded w-1/4"></div>
            ${Array.from({ length: 6 }).map(() => `
              <div class="flex items-center gap-4">
                <div class="h-10 w-10 bg-white/5 rounded-full"></div>
                <div class="flex-1 h-10 bg-white/5 rounded"></div>
              </div>
            `).join('')}
          </div>
        </div>
        <!-- Mobile skeleton -->
        <div class="lg:hidden space-y-4">
          ${Array.from({ length: 4 }).map(() => `
            <div class="glass-card rounded-2xl p-5 animate-pulse">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-white/5 rounded-full"></div>
                <div class="flex-1 h-5 bg-white/5 rounded"></div>
              </div>
              <div class="h-10 bg-white/5 rounded mb-3"></div>
              <div class="h-10 bg-white/5 rounded"></div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  function submitData() {
    const selectedClass = document.getElementById("Class").value;
    const selectedSubject = document.getElementById("Subject").value;
    const selectedExam = document.getElementById("Exam").value;

    document.getElementById("Class").classList.remove("ring-2", "ring-red-500/50");
    document.getElementById("Subject").classList.remove("ring-2", "ring-red-500/50");
    document.getElementById("Exam").classList.remove("ring-2", "ring-red-500/50");

    if ((selectedClass === "" || selectedSubject === "" || selectedExam === "") || (selectedClass === null || selectedSubject === null || selectedExam === null)) {
      showAlert(400, "Please select all options before submitting.");

      if (!selectedClass || selectedClass === "") {
        document.getElementById("Class").classList.add("ring-2", "ring-red-500/50");
      }
      if (!selectedSubject || selectedSubject === "") {
        document.getElementById("Subject").classList.add("ring-2", "ring-red-500/50");
      }
      if (!selectedExam || selectedExam === "") {
        document.getElementById("Exam").classList.add("ring-2", "ring-red-500/50");
      }
      return;
    }

    showSkeleton();

    // Use fetch directly so we can show a premium Error State when something goes wrong
    const params = new URLSearchParams({ subject_id: selectedSubject, class_id: selectedClass, exam_id: selectedExam });

    fetch('/get_marks?' + params.toString())
      .then(res => {
        if (!res.ok) return res.json().then(err => { throw err; });
        return res.json();
      })
      .then(data => {
        const container = document.getElementById('marksTable');
        if (container) container.innerHTML = data.html || '';
      })
      .catch(err => {
        console.error('Error fetching marks:', err);
        showErrorState(err.error || 'An unknown error occurred while fetching marks.');
      });
  }

  function showErrorState(message) {
    const container = document.getElementById('marksTable');
    if (!container) return;
    container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-16 px-4 text-center glass-card rounded-2xl border border-white/5">
        <div class="w-24 h-24 mb-6 rounded-full bg-gradient-to-br from-red-500/20 to-pink-500/20 flex items-center justify-center">
          <i class="fas fa-exclamation-triangle text-4xl text-red-300"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">${message}</h3>
        <p class="text-gray-400 mb-4 max-w-md">Something went wrong</p>
        <div class="flex gap-3">
          <button onclick="submitData()" class="inline-flex items-center gap-2 px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-xl transition">Retry</button>
          <button onclick="location.reload()" class="inline-flex items-center gap-2 px-6 py-3 bg-white/5 hover:bg-white/10 text-gray-200 font-semibold rounded-xl transition">Refresh</button>
        </div>
      </div>
    `;
  }

  // Manage Exams Modal logic (unchanged)
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('manageExamsModal');
    const openBtn = document.getElementById('manageExamsBtn');
    const closeBtns = document.querySelectorAll('.closeModalBtn');

    if (openBtn) {
      openBtn.addEventListener('click', () => {
        modal.classList.remove('modal-hidden');
        document.body.style.overflow = 'hidden';
        loadExams();
      });
    }

    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        modal.classList.add('modal-hidden');
        document.body.style.overflow = '';
      });
    });

    modal.addEventListener('click', (e) => {
      if (e.target.id === 'manageExamsModal') {
        modal.classList.add('modal-hidden');
        document.body.style.overflow = '';
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('modal-hidden')) {
        modal.classList.add('modal-hidden');
        document.body.style.overflow = '';
      }
    });
  });

  function closeModal() {
    document.getElementById('manageExamsModal').classList.add('modal-hidden');
    document.body.style.overflow = '';
  }

  function loadExams() {
    const list = document.getElementById('examsList');
    list.innerHTML = `
      <div class="space-y-3">
        ${Array.from({ length: 3 }).map(() => `
          <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 animate-pulse">
            <div class="h-4 bg-white/5 rounded w-32"></div>
            <div class="h-6 w-11 bg-white/5 rounded-full"></div>
          </div>
        `).join('')}
      </div>
    `;

    fetch('/get_all_exams')
      .then(res => {
        if (!res.ok) throw new Error('Network response was not ok');
        return res.json();
      })
      .then(data => {
        list.innerHTML = '';
        if (!data || data.length === 0) {
          list.innerHTML = '<p class="text-center text-gray-400 py-8">No exams found</p>';
          return;
        }

        data.forEach(exam => {
          const item = document.createElement('div');
          item.className = 'flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition';
          item.innerHTML = `
            <span class="text-white text-sm font-medium">${exam.name || exam.exam_name}</span>
            <button type="button" class="relative inline-flex h-6 w-11 items-center rounded-full transition"
                    aria-pressed="${exam.enabled ? 'true' : 'false'}" data-enabled="${exam.enabled}">
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
            </button>
          `;
          const btn = item.querySelector('button');
          const knob = btn.querySelector('span');

          function applyVisual(enabled) {
            btn.classList.toggle('bg-green-500', enabled);
            btn.classList.toggle('bg-gray-600', !enabled);
            knob.classList.toggle('translate-x-6', enabled);
            knob.classList.toggle('translate-x-1', !enabled);
            btn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
            btn.dataset.enabled = enabled ? 'true' : 'false';
          }

          applyVisual(Boolean(exam.enabled));

          btn.addEventListener('click', () => toggleExam(btn, exam.id));
          list.appendChild(item);
        });
      })
      .catch(error => {
        console.error('Error loading exams:', error);
        list.innerHTML = '<p class="text-center text-red-400 py-8">Failed to load exams</p>';
      });
  }

  function toggleExam(button, examId) {
    const currentlyEnabled = button.dataset.enabled === 'true';
    const desiredEnabled = !currentlyEnabled;
    const knob = button.querySelector('span');

    function applyVisual(enabled) {
      button.classList.toggle('bg-green-500', enabled);
      button.classList.toggle('bg-gray-600', !enabled);
      knob.classList.toggle('translate-x-6', enabled);
      knob.classList.toggle('translate-x-1', !enabled);
      button.setAttribute('aria-pressed', enabled ? 'true' : 'false');
      button.dataset.enabled = enabled ? 'true' : 'false';
    }

    button.disabled = true;
    button.classList.add('opacity-70', 'pointer-events-none');
    applyVisual(desiredEnabled);

    fetch('/update_exam_status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ exam_id: examId, is_enabled: desiredEnabled })
    })
      .then(res => {
        if (!res.ok) throw new Error('Failed to update');
        return res.json();
      })
      .then(() => {
        button.disabled = false;
        button.classList.remove('opacity-70', 'pointer-events-none');
      })
      .catch(error => {
        console.error('Error updating exam:', error);
        applyVisual(currentlyEnabled);
        button.disabled = false;
        button.classList.remove('opacity-70', 'pointer-events-none');
        alert('Failed to update exam status.');
      });
  }
</script>
{% endblock %}