{% extends 'base.html' %}
{% block title %}ID Card Maker{% endblock %}
{% block content %}

<style>
    @font-face {
        font-family: 'League Spartan';
        src: url('/static/LeagueSpartan-Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }
</style>
<!-- Add this style for gradient animation -->
<style>
    @keyframes gradient {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    .animate-gradient {
        animation: gradient 3s ease infinite;
    }
</style>

<div class="min-h-screen text-white">
    <!-- Header -->
    <header class="py-8 md:py-10">
        <div class="mx-auto px-4">
            <!-- Header Content -->
            <div class="text-center mb-10 md:mb-12">
                <div class="inline-flex items-center justify-center mb-4">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center mr-3 shadow-lg shadow-blue-500/20">
                        <i class="fas fa-id-card text-white text-lg"></i>
                    </div>
                    <h1
                        class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 via-cyan-300 to-blue-400 bg-clip-text text-transparent bg-[length:200%_auto] animate-gradient">
                        ID Card Maker
                    </h1>
                </div>
                <p class="text-gray-300 text-lg md:text-xl max-w-3xl mx-auto leading-relaxed px-4">
                    Create and download professional ID cards for your students. Search by name, filter by class, and
                    select multiple cards for batch printing.
                </p>
            </div>

            <!-- Controls Card -->
            <div
                class="rounded-2xl bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 shadow-2xl shadow-black/30 p-6 md:p-8 transition-all duration-300 hover:shadow-blue-900/20">
                <!-- Controls Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Search -->
                    <div class="space-y-3">
                        <label for="search" class="block text-sm font-semibold text-gray-200 flex items-center gap-2">
                            <div
                                class="w-8 h-8 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-search text-blue-400 text-sm"></i>
                            </div>
                            Search Students
                        </label>
                        <div class="relative group">
                            <input type="text" id="search" placeholder="Enter student name..."
                                class="w-full px-4 py-3 bg-gray-900/70 border border-gray-600/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all duration-200 group-hover:border-blue-500/30 shadow-inner shadow-black/20">
                            <!-- Make overlay non-interactive so it doesn't block clicks -->
                            <div
                                class="absolute inset-0 rounded-xl ring-2 ring-blue-500/0 group-focus-within:ring-blue-500/30 transition-all duration-300 pointer-events-none">
                            </div>
                        </div>
                    </div>

                    <!-- Class Filter -->
                    <div class="space-y-3">
                        <label for="class-filter"
                            class="block text-sm font-semibold text-gray-200 flex items-center gap-2">
                            <div
                                class="w-8 h-8 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-school text-blue-400 text-sm"></i>
                            </div>
                            Filter by Class
                        </label>
                        <div class="relative group">
                            <select id="class-filter"
                                class="w-full px-4 py-3 bg-gray-900/70 border border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 appearance-none cursor-pointer transition-all duration-200 group-hover:border-blue-500/30 shadow-inner shadow-black/20">
                                <option value="" class="bg-gray-800">All Classes</option>
                                {% if classes %}
                                {% for class in classes %}
                                <option value="{{ class.id }}" class="bg-gray-800">{{ class.CLASS }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400" aria-hidden="true"></i>
                            </div>
                            <!-- Make overlay non-interactive so it doesn't block clicks -->
                            <div
                                class="absolute inset-0 rounded-xl ring-2 ring-blue-500/0 group-focus-within:ring-blue-500/30 transition-all duration-300 pointer-events-none">
                            </div>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-2">
                            <div
                                class="w-8 h-8 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-cog text-blue-400 text-sm"></i>
                            </div>
                            <label class="text-sm font-semibold text-gray-200">
                                Display Options
                            </label>
                        </div>
                        <div class="space-y-3 pl-10">
                            <label class="flex items-center gap-3 cursor-pointer select-none">
                                <input type="checkbox" id="show-images" class="sr-only peer" checked>

                                <div class="w-5 h-5 rounded-md border-2 border-gray-600
                flex items-center justify-center
                peer-checked:bg-blue-500 peer-checked:border-blue-500
                transition-all duration-200">

                                    <span class="w-2.5 h-1.5 border-b-2 border-l-2 border-white
                     rotate-[-45deg] mb-0.5 hidden peer-checked:block"></span>
                                </div>

                                <span class="text-sm text-gray-300 peer-hover:text-gray-200">
                                    Show only with images
                                </span>
                            </label>

                            <label class="flex items-center group cursor-pointer">
                                <input type="checkbox" id="select-all" class="sr-only peer">

                                <div class="w-5 h-5 rounded-md bg-gray-700 border-2 border-gray-600
                peer-checked:border-blue-500 peer-checked:bg-blue-500/20
                transition-all duration-200 group-hover:border-blue-400
                flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs opacity-0
                  peer-checked:opacity-100 transition-opacity duration-200"></i>
                                </div>

                                <span class="ml-3 text-sm text-gray-300 group-hover:text-gray-200 transition-colors">
                                    Select all visible
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div
                    class="flex flex-col sm:flex-row items-center justify-center gap-4 pt-6 border-t border-gray-700/50">
                    <button id="download-images"
                        class="group relative px-8 py-3.5 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white font-semibold rounded-xl transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 flex items-center gap-3 min-w-[200px] justify-center">
                        <span class="relative z-10 flex items-center gap-2">
                            <i class="fas fa-print text-white"></i>
                            Print ID Cards
                        </span>
                        <div
                            class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-700 to-cyan-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300 -z-0 pointer-events-none">
                        </div>
                    </button>

                    <div id="download-status"
                        class="hidden ml-4 flex items-center gap-3 bg-gray-800/50 px-4 py-2.5 rounded-xl border border-gray-700/50">
                        <div class="relative">
                            <div class="w-5 h-5 border-2 border-gray-600 border-t-blue-400 rounded-full animate-spin">
                            </div>
                        </div>
                        <span class="text-sm text-gray-300 font-medium">Preparing print layout...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="mx-auto py-8">
        <!-- Cards Header -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Preview ID Cards</h2>
            <div class="text-gray-400">
                Showing <span id="visible-count" class="font-semibold text-blue-400">0</span> of <span id="total-count"
                    class="font-semibold text-blue-400">0</span> cards
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6 border border-gray-700">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 text-green-400">
                    <i class="fas fa-check-circle"></i>
                    <span id="selected-count" class="font-semibold">0</span> selected
                </div>
                <div class="flex items-center gap-2 text-blue-400">
                    <i class="fas fa-users"></i>
                    Total students: <span id="total-students" class="font-semibold">0</span>
                </div>
            </div>
        </div>

        <!-- Cards Grid -->
        <div id="cards-grid" class="flex flex-wrap justify-center gap-6" style="max-width: 1300px; margin: 0 auto;">
            <!-- Cards will be dynamically generated here -->
        </div>
    </main>
</div>
<script src="/static/pdf-components/icards/hanging_image_icard.js"></script>
<script>
    /* --- ID Card manager: improved init, checkbox reliability, consistent id types, and robust print wait --- */

    (() => {
        // State (single source)
        let currentStudents = [];
        let selectedStudentIds = new Set();
        let currentClassId = null;
        let schoolData = {};
        let principalSign = '';

        // DOM refs (populated in init)
        let searchInput, classFilter, showImagesCheckbox, selectAllCheckbox, printButton, statusDiv, cardsGrid, visibleCount, totalCount, selectedCount, totalStudents;

        // ---------- Init ----------
        function init() {
            // grab elements AFTER DOM is ready
            searchInput = document.getElementById('search');
            classFilter = document.getElementById('class-filter');
            showImagesCheckbox = document.getElementById('show-images');
            selectAllCheckbox = document.getElementById('select-all');
            printButton = document.getElementById('download-images');
            statusDiv = document.getElementById('download-status');
            cardsGrid = document.getElementById('cards-grid');
            visibleCount = document.getElementById('visible-count');
            totalCount = document.getElementById('total-count');
            selectedCount = document.getElementById('selected-count');
            totalStudents = document.getElementById('total-students');

            setupEventListeners();
            updateUI();
        }

        // ensure init runs even if script loads after DOM has already become interactive
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // ---------- Event listeners ----------
        function setupEventListeners() {
            classFilter.addEventListener('change', handleClassChange);
            searchInput.addEventListener('input', filterAndRenderCards);
            showImagesCheckbox.addEventListener('change', filterAndRenderCards);
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            printButton.addEventListener('click', handlePrint);
            cardsGrid.addEventListener('click', handleCardClick);
        }

        // ---------- API ----------
        async function fetchStudents(classId) {
            try {
                const response = await fetch(`/idcard/api/students/${classId}`);
                if (!response.ok) throw new Error('Failed to fetch students');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching students:', error);
                showAlert(400, 'Failed to load students. Please try again.');
                return null;
            }
        }

        // ---------- Class change ----------
        async function handleClassChange() {
            const classId = classFilter.value;
            if (!classId) {
                currentStudents = [];
                currentClassId = null;
                schoolData = {};
                selectedStudentIds.clear();
                clearCards();
                updateUI();
                return;
            }

            currentClassId = classId;
            const data = await fetchStudents(classId);
            if (data) {
                // normalize ids to Number to avoid type mismatches
                currentStudents = (data.students || []).map(s => ({ ...s, id: Number(s.id) }));
                schoolData = data.school || {};
                sessionYear = data.session_year || '';
                principalSign = data.principal_sign || '';
                selectedStudentIds.clear();
                renderCards();
                updateUI();
            }
        }

        // ---------- Rendering ----------
        function renderCards() {
            clearCards();
            const filteredStudents = getFilteredStudents();
            const fragment = document.createDocumentFragment();
            filteredStudents.forEach(student => {
                const cardWrapper = createCardElement(student);
                fragment.appendChild(cardWrapper);
            });
            cardsGrid.appendChild(fragment);
        }

        function createCardElement(student) {
            const wrapper = document.createElement('div');
            wrapper.className = 'relative bg-gray-800 rounded-xl overflow-hidden shadow-lg transition-all duration-300 hover:scale-105 cursor-pointer';
            wrapper.dataset.studentId = String(student.id); // dataset property is string
            wrapper.style.width = '239px';
            wrapper.style.minWidth = '239px';

            if (selectedStudentIds.has(student.id)) {
                wrapper.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'ring-offset-gray-900');
            }

            const icard = document.createElement('hanging-image-icard');
            icard.setAttribute('school-name', schoolData.name || '');
            icard.setAttribute('school-UDISE', `UDISE: ${schoolData.udise || ''}`);
            icard.setAttribute('school-logo', schoolData.logo || '');
            icard.setAttribute('session-year', sessionYear);
            icard.setAttribute('student-image', student.image ? `https://lh3.googleusercontent.com/d/${student.image}=s220` : '/static/no-student-boy-image.png');
            icard.setAttribute('student-name', student.name);
            icard.setAttribute('student-father', `C/O Mr. ${student.father}`);
            icard.setAttribute('student-class-roll', student.class_roll);
            icard.setAttribute('student-DOB', student.dob);
            icard.setAttribute('student-phone', student.phone || 'N/A');
            icard.setAttribute('student-address', student.address || 'N/A');
            icard.setAttribute('teacher-sign', student.teacher_sign ? `https://lh3.googleusercontent.com/d/${student.teacher_sign}=s200` : '');
            icard.setAttribute('principal-sign', principalSign ? `https://lh3.googleusercontent.com/d/${principalSign}=s200` : '');
            icard.setAttribute('school-address', schoolData.address || '');
            icard.setAttribute('school-phone', schoolData.phone || '');

            wrapper.appendChild(icard);

            const info = document.createElement('div');
            info.className = 'p-3 bg-gray-700 border-t border-gray-600';
            info.innerHTML = `
            <div class="text-white font-semibold text-sm mb-1">${student.name}</div>
            <div class="text-gray-400 text-xs">Class: ${student.class_roll}</div>
        `;
            wrapper.appendChild(info);

            return wrapper;
        }

        // ---------- Selection logic ----------
        function handleCardClick(event) {
            const wrapper = event.target.closest('[data-student-id]');
            if (!wrapper) return;
            const studentId = Number(wrapper.dataset.studentId);
            toggleSelection(studentId);
            updateCardSelectionUI(wrapper, selectedStudentIds.has(studentId));
            updateUI();
        }

        function toggleSelection(studentId) {
            if (selectedStudentIds.has(studentId)) {
                selectedStudentIds.delete(studentId);
            } else {
                selectedStudentIds.add(studentId);
            }
        }

        function updateCardSelectionUI(wrapper, isSelected) {
            if (isSelected) {
                wrapper.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'ring-offset-gray-900');
            } else {
                wrapper.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'ring-offset-gray-900');
            }
        }

        function handleSelectAll() {
            const filteredStudents = getFilteredStudents();
            const allSelected = filteredStudents.length > 0 && filteredStudents.every(s => selectedStudentIds.has(s.id));

            if (allSelected) {
                filteredStudents.forEach(s => selectedStudentIds.delete(s.id));
            } else {
                filteredStudents.forEach(s => selectedStudentIds.add(Number(s.id)));
            }

            renderCards();
            updateUI();
        }

        // ---------- Filtering ----------
        function getFilteredStudents() {
            let filtered = currentStudents || [];

            const searchTerm = (searchInput.value || '').toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const name = (s.name || '').toLowerCase();
                    const classRoll = (s.class_roll ?? '').toString().toLowerCase();
                    return name.includes(searchTerm) || classRoll.includes(searchTerm);
                });
            }

            if (showImagesCheckbox.checked) {
                filtered = filtered.filter(s => s.image);
            }

            return filtered;
        }

        function filterAndRenderCards() {
            renderCards();
            updateUI();
        }

        function clearCards() {
            cardsGrid.innerHTML = '';
        }

        function updateUI() {
            const filtered = getFilteredStudents();
            visibleCount.textContent = filtered.length;
            totalCount.textContent = currentStudents.length || 0;
            selectedCount.textContent = selectedStudentIds.size;
            totalStudents.textContent = currentStudents.length || 0;

            // sync hidden checkbox state
            selectAllCheckbox.checked = filtered.length > 0 && filtered.every(s => selectedStudentIds.has(s.id));
            selectAllCheckbox.indeterminate = filtered.some(s => selectedStudentIds.has(s.id)) && !selectAllCheckbox.checked;

            // Update select-all visual icon
            const selectAllDiv = selectAllCheckbox.nextElementSibling;
            const icon = selectAllDiv.querySelector('i');
            if (selectAllCheckbox.indeterminate) {
                icon.classList.remove('fa-check');
                icon.classList.add('fa-minus');
                icon.style.opacity = '1';
            } else if (selectAllCheckbox.checked) {
                icon.classList.remove('fa-minus');
                icon.classList.add('fa-check');
                icon.style.opacity = '1';
            } else {
                icon.classList.remove('fa-minus');
                icon.classList.add('fa-check');
                icon.style.opacity = '0';
            }
        }

        // ---------- Alerts ----------
        function showAlert(type = 200, message = '') {
            try {
                const toast = document.createElement('div');
                toast.className = 'fixed top-6 right-6 z-50 bg-gray-900 text-white px-4 py-2 rounded shadow';
                toast.textContent = message || (type === 200 ? 'Done' : 'Error');
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.transition = 'opacity 300ms';
                    toast.style.opacity = '0';
                }, 2000);
                setTimeout(() => toast.remove(), 2400);
            } catch (e) {
                console.log('Alert:', message);
            }
        }

        // ---------- PRINT (wait for fonts & images in new window) ----------
        async function handlePrint() {
            if (selectedStudentIds.size === 0) {
                showAlert(400, 'Please select at least one ID card to print.');
                return;
            }

            printButton.disabled = true;
            statusDiv.classList.remove('hidden');

            try {
                const selectedStudents = currentStudents.filter(s => selectedStudentIds.has(s.id));
                const html = await generatePrintHTML(selectedStudents);

                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showAlert(400, 'Popup blocked. Allow popups for this site to print.');
                    return;
                }

                // Write document and inject small script that waits for images & fonts then prints.
                printWindow.document.open();
                printWindow.document.write(html);
                printWindow.document.close();

                // Safety: If load already happened, still run the waiting script.
                // We inject a script into the printed page which waits for all images and fonts then calls print()
                // This ensures that modal opens only after images/fonts are ready.
            } finally {
                printButton.disabled = false;
                statusDiv.classList.add('hidden');
            }
        }

        async function generatePrintHTML(students) {
            const cardsPerPage = 9;
            const cssText = await fetch("/static/pdf-components/icards/hanging_image_icard.css").then(r => r.text());

            // Helper that creates per-card HTML by populating the template
            async function generateCardHTML(student) {
                const rawHTML = await fetch("/static/pdf-components/icards/hanging_image_icard.html").then(r => r.text());
                const wrapper = document.createElement('div');
                wrapper.innerHTML = rawHTML.trim();

                const setText = (id, value) => {
                    const el = wrapper.querySelector(`#${id}`);
                    if (el) el.textContent = value ?? "";
                };
                const setSrc = (id, value) => {
                    const el = wrapper.querySelector(`#${id}`);
                    if (el) el.src = value ?? "";
                };

                setText("school-name", schoolData.name);
                setText("school-UDISE", `UDISE: ${schoolData.udise}`);
                setSrc("school-logo", schoolData.logo);
                setText("session-year", sessionYear);

                setSrc("student-image", student.image ? `https://lh3.googleusercontent.com/d/${student.image}=s220` : "/static/no-student-boy-image.png");
                setText("student-name", student.name);
                setText("student-father", `C/O Mr. ${student.father}`);
                setText("student-class-roll", student.class_roll);
                setText("student-DOB", student.dob);
                setText("student-phone", student.phone || "N/A");
                setText("student-address", student.address || "N/A");
                setSrc("teacher-sign", student.teacher_sign ? `https://lh3.googleusercontent.com/d/${student.teacher_sign}=s200` : "");
                setSrc("principal-sign", principalSign ? `https://lh3.googleusercontent.com/d/${principalSign}=s200` : "");

                setText("school-address", schoolData.address);
                setText("school-phone", schoolData.phone);

                return wrapper.innerHTML;
            }

            // Script that waits for images & fonts then calls print()
            const waitPrintScript = `
            <script>
            (function() {
            function waitForImagesAndFonts() {
                const imgs = Array.from(document.images);
                const imgPromises = imgs.map(img => img.complete ? Promise.resolve() : new Promise(r => { img.addEventListener('load', r); img.addEventListener('error', r); }));
                const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
                return Promise.all([...imgPromises, fontsReady]);
            }

            function kickPrint() {
                // slight delay to allow browser to finish layout/render
                setTimeout(() => { try { window.focus(); window.print(); } catch(e) { console.error(e); } }, 200);
            }

            if (document.readyState === 'complete') {
                waitForImagesAndFonts().then(kickPrint);
            } else {
                window.addEventListener('load', () => waitForImagesAndFonts().then(kickPrint));
            }
            })();
            <\/script>
            `;

            let html = `
            <!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>ID Cards Print</title><style>${cssText}
                @font-face { font-family: 'League Spartan'; src: url('/static/LeagueSpartan-Regular.ttf') format('truetype'); }
                /* ---------- PRINT LAYOUT ONLY ---------- */
                .print-page {
                    width: 210mm; height: 297mm;
                    display: grid; grid-template-columns: repeat(3, 63mm); grid-template-rows: repeat(3, 88mm);
                    column-gap: 5mm; row-gap: 5mm; justify-content: space-between; align-content: space-between;
                    padding: 10mm; box-sizing: border-box; page-break-after: always;
                }
                .print-page:last-child { page-break-after: auto; }
                .print-card { display:flex; align-items:center; justify-content:center; break-inside:avoid; page-break-inside:avoid; }
                @media print {
                body { margin:0; padding:0; }
                .print-card { position:relative; padding:1mm; box-sizing:border-box; border:0.3mm dotted #777; }
                }
                @page { size: A4; margin: 8mm; }
            </style></head><body>`;

            for (let i = 0; i < students.length; i += cardsPerPage) {
                html += `<div class="print-page">`;
                for (let j = 0; j < cardsPerPage && i + j < students.length; j++) {
                    const cardHtml = await generateCardHTML(students[i + j]);
                    html += `<div class="print-card">${cardHtml}</div>`;
                }
                html += `</div>`;
            }

            // append script that will wait for images & fonts then print
            html += waitPrintScript;
            html += `</body></html>`;
            return html;
        }
    })();
</script>

{% endblock %}