{% extends "base.html" %}
{% block title %}Create Paper{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">



<style>
  .font-size-label {
    font-size: 1.2rem;
    font-weight: bold;
    color: #4A90E2;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .font-size-value {
    background: #4A90E2;
    color: white;
    font-weight: bold;
    padding: 2px 10px;
    border-radius: 8px;
    font-size: 1.1rem;
    min-width: 40px;
    text-align: center;
  }

  /* Dark theme for all inputs, selects, and textareas */
  input.form-control,
  select.form-select,
  textarea.form-control {
    background-color: #2c2c2c !important;
    /* dark grey */
    color: #f1f1f1 !important;
    /* light text */
    border: 1px solid #555 !important;
  }

  input.form-control::placeholder,
  textarea.form-control::placeholder {
    color: #bbb !important;
  }

  input.form-control:focus,
  select.form-select:focus,
  textarea.form-control:focus {
    background-color: #3a3a3a !important;
    color: #fff !important;
    border-color: #4A90E2 !important;
    outline: none !important;
    box-shadow: none !important;
  }

  /* Optional: style datalist options */
  option {
    background-color: #2c2c2c;
    color: #f1f1f1;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<div class="d-flex flex-column justify-content-center align-items-center mb-3">


  <input type="text" class="event form-control text-center fw-bold mb-2 w-75" list="EventList" placeholder="Event">
  <datalist id="EventList">
    <option value="Formative Assessment - I">
    <option value="Summative Assessment - I">
    <option value="Formative Assessment - II">
    <option value="Summative Assessment - II">
  </datalist>

  <input type="text" class="subject form-control text-center fw-bold mb-2 w-50" list="SubjectList"
    placeholder="Subject">
  <datalist id="SubjectList">
    <option value="English">
    <option value="Hindi">
    <option value="Math">
    <option value="Science">
    <option value="Computer">
    <option value="S.S.T">
    <option value="Urdu">
    <option value="G.K">
  </datalist>

  <div class="d-flex justify-content-between">
    <input type="text" class="hrs form-control text-center fw-bold" style="width: 60px;" placeholder="hrs">

    <input type="text" class="class form-control text-center fw-bold" style="width: 25%;" list="ClassList"
      placeholder="Class">
    <datalist id="ClassList">
      <option value="Nursery">
      <option value="LKG">
      <option value="UKG">
      <option value="I">
      <option value="II">
      <option value="III">
      <option value="IV">
      <option value="V">
      <option value="VI">
      <option value="VII">
      <option value="VIII">
    </datalist>

    <input type="text" class="M-M form-control text-center fw-bold" style="width: 60px;" list="mList" placeholder="M.M">
    <datalist id="mList">
      <option value="20">
      <option value="80">
    </datalist>

  </div>
</div>


<div id="content" style="width: 100%;">
  <div class="question-block d-flex flex-column align-items-end mb-4">
    <div class="question input-group mb-2">
      <select class="form-select fw-bold" rows="1" style="overflow: hidden; resize: none;" onchange="addQuestion(this)">
        <option selected>Select Question Type</option>
        <option value="mcq">Multiple Choice Questions</option>
        <option value="fillUp">Fill In The Blanks</option>
        <option value="TF">True or False</option>
        <option value="match">Matching</option>
        <option value="QnA">Question & Answers</option>
        <option value="singleWord">Single Word Questions</option>
      </select>

      <button class="btn btn-success ms-1" onclick="addQuestionBlock(this)"
        style="width: 35px; height: 40px;">+</button>
      <button class="btn btn-danger ms-1" onclick="removeQuestionBlock(this)"
        style="width: 35px; height: 40px;">-</button>
    </div>

    <div class="questionWrapper w-100">
      <!-- Question will be rendered here -->
    </div>
  </div>

</div>

<div class="container mt-5">
  <label for="customRange" class="form-label font-size-label">
    Font Size: <span id="fontSize" class="font-size-value">20</span>
  </label>
  <input type="range" class="form-range" min="10" max="30" step="1" id="customRange" value="20"
    oninput="updateRangeValue(this.value)">
</div>


<div class="container text-center mt-3">
  <div class="row">
    <div class="col-12 col-md-6 mb-2">
      <button class="btn btn-primary w-100" onclick="convert()">Convert</button>
    </div>
    <div class="col-12 col-md-6 mb-2">
      <button class="btn btn-secondary w-100" onclick="clearLocalStorage()">Clear</button>
    </div>
  </div>
</div>


<script>


  let state = {
    meta: { event: '', subject: '', std: '', hrs: '', MM: '', fontSize: 18 },
    questions: []
  }

  questionHeadingText = {
    "mcq": "Multiple Choice Questions",
    "fillUp": "Fill Ups",
    "match": "Match the Following",
    "QnA": "Question and Answer",
    "TF": "True or False",
    "singleWord": "Single Word Questions"
  }

  var questionCount = 1

  const templates = {
    QuestionSelect: () => `
    <div class="question-block d-flex flex-column align-items-end mb-4">
        <div class="question input-group mb-2">
            <select class="form-select fw-bold" rows="1" style="overflow: hidden; resize: none;"
                onchange="addQuestion(this)">
                <option selected>Select Question Type</option>
                <option value="mcq">Multiple Choice Questions</option>
                <option value="fillUp">Fill In The Blanks</option>
                <option value="TF">True or False</option>
                <option value="match">Matching</option>
                <option value="QnA">Question & Answers</option>
                <option value="singleWord">Single Word Questions</option>
            </select>

            <button class="btn btn-success ms-1" onclick="addQuestionBlock(this)" style="width: 35px; height: 40px;">+</button>
            <button class="btn btn-danger ms-1" onclick="removeQuestionBlock(this)" style="width: 35px; height: 40px;">-</button>
        </div>

        <div class="questionWrapper w-100">
            <!-- Question will be rendered here -->
        </div>
    </div>
    `,

    mcq: () => `
    <div class="sub-question input-group mb-4" style="width: 98%; margin-left: auto;">
      <textarea class="subQuestionText form-control me-1 mb-2" placeholder="MCQ Question" rows="1"
          style="overflow-y: hidden; resize: none;" oninput="resizeTextHeight(this)" required></textarea>
      <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)"
          style="width: 35px; height: 38px;">+</button>
      <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>

      <!-- Option Inputs shifted to the right with margin -->
      <div class="input-group mb-1 ms-auto" style="width: 98%;">
          <input type="text" class="option rounded-pill form-control" placeholder="Option 1" required>
          <input type="text" class="option rounded-pill form-control ms-2" placeholder="Option 2" required>
      </div>
      <div class="input-group ms-auto" style="width: 98%;">
          <input type="text" class="option rounded-pill form-control" placeholder="Option 3" required>
          <input type="text" class="option rounded-pill form-control ms-2" placeholder="Option 4" required>
      </div>
    </div>
    `,

    match: () => `
    <div class="sub-question input-group mb-1" style="width: 98%; margin-left: auto;">
        <input type="text" class="matchingLeft rounded-pill form-control" placeholder="Match 1" required>
        <input type="text" class="matchingRight rounded-pill form-control" placeholder="Match 2" required>

        <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)" style="width: 35px; height: 38px;">+</button>
        <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>
    </div>

  `,

    singleWord: () => `
    <div class="sub-question input-group mb-1" style="width: 98%; margin-left: auto;">
        <input type="text" class="subQuestionText rounded-pill form-control" placeholder="Enter the word" required>

        <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)" style="width: 35px; height: 38px;">+</button>
        <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>
    </div>

  `,

    fillUp: () => `
    <div class="sub-question input-group mb-1" style="width: 98%; margin-left: auto;">

        <textarea class="subQuestionText form-control mb-1" placeholder="Fill Up Question" rows="1"
            style="overflow-y: hidden; resize: none;" oninput="resizeTextHeight(this)" required></textarea>
        <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)" style="width: 35px; height: 38px;">+</button>
        <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>
    </div>
    `,

    QnA: () => `
      <div class="sub-question input-group mb-1" style="width: 98%; margin-left: auto;">
          <textarea class="subQuestionText form-control mb-1" placeholder="Question and Answers" rows="1"
              style="overflow-y: hidden; resize: none;" oninput="resizeTextHeight(this)" required></textarea>
          <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)" style="width: 35px; height: 38px;">+</button>
          <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>
      </div>
    `,

    TF: () => `
    <div class="sub-question input-group mb-1" style="width: 98%; margin-left: auto;">
      <textarea class="subQuestionText form-control mb-1" placeholder="True/False Question" rows="1"
          style="overflow-y: hidden; resize: none;" oninput="resizeTextHeight(this)" required></textarea>
      <button class="btn btn-outline-success ms-1" onclick="addSubQuestion(this)" style="width: 35px; height: 38px;">+</button>
      <button class="btn btn-outline-danger ms-1" onclick="removeSubQuestion(this)" style="width: 35px; height: 38px;">-</button>
    </div>
    `,
  };


  function debounce(fn, wait = 600) {
    let t;
    return (...a) => {
      clearTimeout(t);               // Cancel any previously scheduled call
      t = setTimeout(() => fn(...a), wait);  // Schedule new call after `wait` ms
    };
  }


  function saveCurrentState() {

    state.meta.event = document.querySelector(".event").value || "";
    state.meta.subject = document.querySelector(".subject").value || "";
    state.meta.std = document.querySelector(".class").value || "";
    state.meta.hrs = document.querySelector(".hrs").value || "";
    state.meta.MM = document.querySelector(".M-M").value || "";
    state.meta.fontSize = document.getElementById("customRange").value || "20";

    console.log(document.querySelector(".event").value)


    const questionBlocks = document.querySelectorAll(".question-block");

    state.questions = Array.from(questionBlocks).map(questionBlock => {
      const type = questionBlock.querySelector("select")?.value;
      const qText = questionBlock.querySelector(".q-text")?.value || "";
      const marks = questionBlock.querySelector(".m-text")?.value || "";

      const questionWrapper = questionBlock.querySelector(".questionWrapper") || [];
      let subQuestion = [];
      let options = [];

      if (type === "mcq") {
        const mcqItems = questionWrapper.querySelectorAll(".sub-question");
        subQuestion = Array.from(mcqItems).map(mcq => ({
          text: mcq.querySelector('.subQuestionText')?.value || "",
          options: Array.from(mcq.querySelectorAll(".option")).map(opt => opt.value)
        }));
      }
      else if (type === "match") {
        subQuestion = Array.from(questionWrapper.querySelectorAll(".matchingLeft")).map(el => el.value);
        options = Array.from(questionWrapper.querySelectorAll(".matchingRight")).map(el => el.value);
      }
      else {
        subQuestion = Array.from(questionWrapper.querySelectorAll(".subQuestionText")).map(el => el.value);
      }

      const questionObj = { type, qText, marks, subQuestion };
      if (type === "match") questionObj.options = options;


      return questionObj;
    });

    localStorage.setItem("questionPaperJSON", JSON.stringify(state));
  }


  function addQuestionBlock(addBTN = null) {
    const container = document.getElementById("content");
    const questionSelectHTML = templates['QuestionSelect']();

    if (!addBTN) {
      // Append at the end
      container.insertAdjacentHTML('beforeend', questionSelectHTML);
    } else {
      addBTN.closest('.question-block').insertAdjacentHTML('afterend', questionSelectHTML);
    }

    saveCurrentState();
  }


  function addQuestion(selectElement) {
    // Adding Question after selecting from dropdown
    const questionBlock = selectElement.closest('.question-block');
    const questionWrapper = questionBlock.querySelector('.questionWrapper');
    const selectedType = selectElement.value;

    if (!questionWrapper || !selectedType || !templates[selectedType]) return;

    // Remove any previous question content under this wrapper
    questionWrapper.innerHTML = '';
    const questionHeading = `
      <div class="d-flex w-100">
        <input type="text" class="q-text form-control mb-2 me-1 " placeholder="Enter Question Text" value="${questionHeadingText[selectedType] || ''}">
        <input type="number" class="m-text form-control mb-2" placeholder="Marks" style="width: 75px;">
      </div>
      `
    questionWrapper.insertAdjacentHTML('beforeend', questionHeading);
    questionWrapper.insertAdjacentHTML('beforeend', templates[selectedType]());

    // Update state immediately after rendering
    saveCurrentState();
  }


  function addSubQuestion(addBtn) {
    const questionBlock = addBtn.closest('.question-block');
    const selectedType = questionBlock.querySelector("select").value;
    const questionWrapper = addBtn.closest('.questionWrapper');

    if (!questionWrapper || !selectedType || !templates[selectedType]) return;

    // Create a container for the question template
    questionWrapper.insertAdjacentHTML('beforeend', templates[selectedType]());

    // Update state immediately after rendering
    saveCurrentState();
  }


  function removeSubQuestion(remBTN) {
    const subQuestion = remBTN.closest('.sub-question');
    if (!subQuestion) return;

    // Find the parent wrapper of this sub-question
    const questionWrapper = remBTN.closest('.questionWrapper');
    if (!questionWrapper) return;

    // Count all sub-questions in this wrapper
    const allSubs = questionWrapper.querySelectorAll('.sub-question');

    // If there's only one, don't remove it
    if (allSubs.length <= 1) return;

    subQuestion.remove();

    saveCurrentState()
  }


  function removeQuestionBlock(remBTN) {
    const questionBlock = remBTN.closest('.question-block');
    if (!questionBlock) return;

    // Count all question blocks
    const allBlocks = document.querySelectorAll('.question-block');

    // If there's only one left, don't remove it
    if (allBlocks.length <= 1) return;

    questionBlock.remove();

    saveCurrentState();
  }


  async function convert() {

    let questions = [];

    const eventName = document.getElementsByClassName("event")[0].value
    const subject = document.getElementsByClassName("subject")[0].value
    const std = document.getElementsByClassName("class")[0].value
    const hrs = document.getElementsByClassName("hrs")[0].value
    const MM = document.getElementsByClassName("M-M")[0].value
    const fontSize = document.getElementsByClassName("font-size-value")[0].textContent

    if (!eventName || !std) {
      alert("Please Fill the class and event");
      return;
    }


    const html = await updatePage('/question_paper_api', null, {
      questions: state.questions, eventName: eventName, subject: subject,
      std: std, hrs: hrs, MM: MM, value: "a4PDF", fontSize: fontSize
    })


    const newWindow = window.open("", "_blank");

    newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <style>
                @page {
                    margin: 0px;
                    size: A4;
                }
                body {
                    margin: 0;
                    padding: 6px;
                    width: 210mm;
                    height: 297mm;
                    color: black;
                    background: rgb(255, 555, 255);
                    line-height: 1.2;
                }
                .content {
                    font-size: ${fontSize}px;
                    margin-top:5px
                }
                .paperHeader {
                    font-size: 20px;
                }
                .question-block {
                    page-break-inside: avoid;
                    break-inside: avoid;
                }

                @media print {
                    body {
                        page-break-after: always;
                    }
                }
                </style>
            </head>
            <body>
                ${html}
                <script>
                // When the new window loads, trigger the print dialog
                window.onload = function() {
                    window.print();
                };
                <\/script>
            </body>
            </html>
        `);
    newWindow.document.close();
  }

  function updateRangeValue(value) {
    const label = document.getElementById('fontSize');
    label.textContent = value;
    label.style.fontSize = value + "px";

  }

  function clearLocalStorage() {
    if (confirm("Are you sure you want to clear the local storage?")) {
      localStorage.removeItem("questionPaperJSON");
      window.location.reload();
    }
  }


  function resizeTextHeight(textarea) {
    textarea.style.height = 'auto'; // Reset height to auto to shrink if needed
    textarea.style.height = textarea.scrollHeight + 'px'; // Adjust height based on content
  }

  // ...existing code...
  function renderJson(json) {
    // Restore meta fields if present
    if (json && json.meta) {
      document.querySelector(".event").value = json.meta.event || "";
      document.querySelector(".subject").value = json.meta.subject || "";
      document.querySelector(".class").value = json.meta.std || "";
      document.querySelector(".hrs").value = json.meta.hrs || "";
      document.querySelector(".M-M").value = json.meta.MM || "";
      document.getElementById("fontSize").textContent = json.meta.fontSize || "20";
      document.getElementById("customRange").value = json.meta.fontSize || "20";
    }

    // If no questions, render one empty block
    if (!json || !json.questions || !Array.isArray(json.questions) || json.questions.length === 0) {
      console.log("No questions found, rendering empty block.");
      return;
    }

    // Clear container first
    const container = document.getElementById("content");
    container.innerHTML = "";

    json.questions.forEach((q) => {
      if (!q.type || !templates[q.type]) return;

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = templates.QuestionSelect();
      const questionBlock = tempDiv.firstElementChild;

      const select = questionBlock.querySelector("select");
      select.value = q.type;

      const questionWrapper = questionBlock.querySelector(".questionWrapper");
      questionWrapper.innerHTML = `
            <div class="d-flex w-100">
                <input type="text" class="q-text form-control mb-2 me-1" value="${q.qText || ""}" placeholder="Enter Question Text">
                <input type="number" class="m-text form-control mb-2" value="${q.marks || ""}" placeholder="Marks" style="width: 75px;">
            </div>
        `;

      if (q.type === "mcq" && Array.isArray(q.subQuestion)) {
        q.subQuestion.forEach(sq => {
          questionWrapper.insertAdjacentHTML('beforeend', templates.mcq());
          const lastSub = questionWrapper.querySelector(".sub-question:last-child");
          lastSub.querySelector(".subQuestionText").value = sq.text || "";
          const optionInputs = lastSub.querySelectorAll(".option");
          (sq.options || []).forEach((opt, i) => { if (optionInputs[i]) optionInputs[i].value = opt; });
        });
      } else if (q.type === "match" && Array.isArray(q.subQuestion)) {
        q.subQuestion.forEach((left, i) => {
          questionWrapper.insertAdjacentHTML('beforeend', templates.match());
          const lastSub = questionWrapper.querySelector(".sub-question:last-child");
          lastSub.querySelector(".matchingLeft").value = left || "";
          lastSub.querySelector(".matchingRight").value = (q.options && q.options[i]) || "";
        });
      } else if (Array.isArray(q.subQuestion)) {
        q.subQuestion.forEach(sq => {
          questionWrapper.insertAdjacentHTML('beforeend', templates[q.type]());
          const lastSub = questionWrapper.querySelector(".sub-question:last-child");
          lastSub.querySelector(".subQuestionText").value = sq || "";
        });
      }

      container.appendChild(questionBlock);
    });

    // <-- Add this line to sync the state after rendering
    saveCurrentState();
  }

  document.addEventListener("DOMContentLoaded", () => {
    const savedJSON = JSON.parse(localStorage.getItem("questionPaperJSON") || "[]");
    renderJson(savedJSON);

    // Event delegation for the whole page
    document.addEventListener("input", function (e) {
      const target = e.target;
      const tag = target.tagName.toLowerCase();

      if (
        (tag === "input" && (target.type === "text" || target.type === "number")) ||
        tag === "textarea" ||
        tag === "select"
      ) {
        saveCurrentState();
      }
    });
  });



</script>

{% endblock %}