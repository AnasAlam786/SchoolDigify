{% extends "base.html" %} {% block title %}Promote Students & TC{% endblock %} {% block
content %}

<style>
    .promotion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(0, 420px));
        gap: 16px;
        /* space between cards */
        justify-content: center;
        /* leftover space only on sides */
        align-items: start;
        width: 100%;
        box-sizing: border-box;
    }

    /* On very small screens (phones), force 1 card per row */
    @media (max-width: 480px) {
        .spromotion-cards {
            grid-template-columns: 1fr;
            /* single column full width */
        }
    }

    /* Card styling */
    .student-image {
        border: 3px solid #8f94fb;
        object-position: top;
        object-fit: cover;
        display: block;
        width: 120px;
        height: 160px;
    }

    .card-hover {
        transition: all 0.3s ease;
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #333;
    }

    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        border-color: #4e54c8;
    }

    .modal {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .modal-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.9);
    }

    .modal-visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
    }


    /* âœ… Hide scrollbar but allow scroll for modal*/
    .hide-scrollbar {
        scrollbar-width: none;
        /* Firefox */
        -ms-overflow-style: none;
        /* IE & Edge */
    }

    .hide-scrollbar::-webkit-scrollbar {
        display: none;
        /* Chrome, Safari */
    }
</style>

<div class="container" id="student-container">

    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-green-400 ">Student Promotion Portal</h1>
            <p class="text-gray-400 mt-1 md:mt-2 text-sm md:text-base">
                Manage student promotions to the next academic session with an intuitive interface
            </p>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="flex flex-col gap-3 mb-6 md:mb-10">
        <!-- Search Box -->
        <div class="p-3 rounded-lg md:rounded-xl bg-[#1e1e1e]">
            <div class="flex items-center">
                <i class="fas fa-search text-gray-500 mr-3"></i>
                <input type="text" id="search-input" oninput="applyFilters()"
                    placeholder="Search by name or roll number..."
                    class="w-full bg-transparent border-0 text-white placeholder-gray-500 focus:outline-none text-sm md:text-base">
            </div>
        </div>

        <!-- Dropdown -->
        <div class="relative">
            <div class="flex items-center p-3 rounded-lg md:rounded-xl bg-[#1e1e1e]">
                <!-- Left Icon -->
                <i class="fas fa-layer-group text-gray-500 mr-3"></i>

                <!-- Select -->
                <select id="classView"
                    class="w-full appearance-none cursor-pointer text-gray-400 text-sm md:text-base bg-transparent focus:outline-none pr-8">
                    <option class="bg-[#1e1e1e] text-white" selected hidden value="">Select Class</option>
                    {% if classes %}
                    {% for class in classes %}
                    <option class="bg-[#1e1e1e] text-white" value="{{ class.id }}">{{ class.CLASS }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Right Chevron -->
            <i
                class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
        </div>

            <!-- State badges -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 mt-3">
        <button data-filter-button="ALL"
            class="bg-gray-700 text-white rounded-xl px-4 py-3 flex items-center justify-between gap-2 shadow hover:bg-gray-600 transition-colors">
            <span class="font-semibold">All</span>
            <span class="bg-gray-900 px-3 py-1 rounded-full text-sm" id="badge-all-count">-</span>
        </button>
        <button data-filter-button="PROMOTED"
            class="bg-gray-700 text-white rounded-xl px-4 py-3 flex items-center justify-between gap-2 shadow hover:bg-gray-600 transition-colors">
            <span class="font-semibold">Promoted</span>
            <span class="bg-green-900 px-3 py-1 rounded-full text-sm" id="badge-promoted-count">0</span>
        </button>
        <button data-filter-button="TC_ISSUED"
            class="bg-gray-700 text-white rounded-xl px-4 py-3 flex items-center justify-between gap-2 shadow hover:bg-gray-600 transition-colors">
            <span class="font-semibold">TC Issued</span>
            <span class="bg-amber-900 px-3 py-1 rounded-full text-sm" id="badge-tc-count">0</span>
        </button>
        <button data-filter-button="NOT_PROMOTED_NOT_TC"
            class="bg-gray-700 text-white rounded-xl px-4 py-3 flex items-center justify-between gap-2 shadow hover:bg-gray-600 transition-colors">
            <span class="font-semibold">No Action</span>
            <span class="bg-slate-900 px-3 py-1 rounded-full text-sm" id="badge-none-count">0</span>
        </button>
    </div>

    </div>

    <div class="promotion-cards" id="StudentData"></div>
</div>

<!-- No Results Section (Initially Hidden) -->
<div id="noResults" class="no-results hidden mt-16 text-center">
    <div class="bg-gray-800 rounded-2xl p-10 border border-gray-700 max-w-2xl mx-auto">
        <i class="fas fa-search text-5xl text-gray-500 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-300 mb-2">No Students Found</h3>
        <p class="text-gray-500">Try adjusting your search or filter criteria to find what you're looking for.</p>
    </div>
</div>

<!-- Student Promotion Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-hidden"
    id="studentPromotionModal">
    <div class="bg-gray-800 rounded-lg w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col" id="modalContent">

        <!-- Modal Header -->
        <div class="relative bg-blue-600 p-4 rounded-t-lg flex items-center justify-center">
            <i class="fas fa-school text-white text-xl mr-2"></i>
            <h5 class="text-white text-xl font-bold" id="modalTitle">Promote Student</h5>

            <!-- Close button -->
            <button type="button"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-200 text-xl"
                id="closeModal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body (scrollable, scrollbar hidden) -->
        <div class="flex-1 overflow-y-auto px-6 py-5 hide-scrollbar">
            <form id="promotionForm" class="px-6">
                <!-- Student Image and Name -->
                <div class="flex flex-col items-center mb-3">
                    <img id="studentImage" src="" alt="Student Image" class="student-image w-32 h-32 rounded-full mb-2" loading="lazy">

                    <h3 id="studentName" data-id="" class="text-2xl font-bold text-white text-center"></h3>
                    <p id="father" class="text-gray-400 text-center"></p>
                </div>

                <!-- Details Table -->
                <div class="bg-gray-700 rounded-xl p-4 mb-5">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-gray-300 font-medium">Old Class</span>
                            <span id="oldClass" class="text-white font-semibold"></span>
                        </div>
                    </div>
                </div>

                <!-- Input Fields -->
                <div class="space-y-4">
                    <div>
                        <label for="promotedClass" class="block text-gray-300 mb-2 font-medium">Promote To Class <span
                                class="text-red-400">*</span></label>
                        <select id="promotedClass" name="promotedClass" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200 appearance-none cursor-pointer">

                        </select>
                        <p id="promotedClassError" class="error-message hidden mt-1" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="newRoll" class="block text-gray-300 mb-2 font-medium">New Roll Number <span
                                class="text-red-400">*</span></label>
                         <input type="number" inputmode="numeric" id="newRoll" name="newRoll" required
-                            class="w-full bg-gray-700  rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
-                            placeholder="Enter new roll number">
                        <p id="newRollError" class="error-message hidden" style="color: red;"></p>
                        <p id="availableRolls" class="text-sm text-gray-400 mt-1">Available rolls: Loading...</p>
                    </div>

                    <div>
                        <label for="promotion_date" class="block text-gray-300 mb-2 font-medium">Promotion Date <span
                                class="text-red-400">*</span></label>
                        <input type="date" id="promotion_date" name="promotion_date" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200">
                        <p id="dateError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div class="hidden pt-2" id="depromoteCheckboxContainer">
                        <div class="flex items-start">
                            <input
                                class="form-check-input mt-1 mr-3 w-5 h-5 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500"
                                type="checkbox" id="depromoteCheckbox">
                            <div>
                                <label class="text-red-300 font-medium" for="depromoteCheckbox">
                                    Depromote Student, can be risky.
                                </label>
                                <p class="text-red-400 text-sm mt-1">
                                    <strong>This action cannot be undone.</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- Modal Footer -->
        <div class="bg-gray-700 rounded-b-lg border-t border-gray-600 px-6 py-3 flex flex-wrap gap-3 justify-between">

            <!-- Close button on the left -->
            <div>
                <button type="button"
                    class="px-3 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-medium transition-colors duration-200"
                    onclick="closeModal()">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>

            <!-- Action buttons on the right -->
            <div class="flex flex-wrap gap-3" id="modal-footer">

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 flex items-center"
                    id="promoteButton">
                    <span id="promoteSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-check-circle mr-2"></i>
                    Promote
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="depromoteButton">
                    <span id="depromoteSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-times-circle mr-2"></i>
                    Depromote
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="updateButton">
                    <span id="updateSpinner"
                        class="spinner-border hidden h-4 w-4 mr-2 border-2 border-t-transparent rounded-full"></span>
                    <i class="fas fa-sync-alt mr-2"></i>
                    Update
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="messageButton">
                    <i class="fas fa-whatsapp mr-2"></i>
                    Send Message
                </button>
            </div>

        </div>

    </div>
</div>

<!-- Student TC generation Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-hidden"
    id="studenttcModal">
    <div class="bg-gray-800 rounded-lg w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col" id="tc-modalContent">

        <!-- Modal Header -->
        <div class="relative bg-blue-600 p-4 rounded-t-lg flex items-center justify-center">
            <i class="fas fa-school text-white text-xl mr-2"></i>
            <h5 class="text-white text-xl font-bold" id="tc-modalTitle"></h5>
            <button type="button"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-200 text-xl"
                id="tc-closeModal" onclick="closeTCModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body (scrollable, scrollbar hidden) -->
        <div class="flex-1 overflow-y-auto px-6 py-5 hide-scrollbar">
            <form id="promotionForm" class="px-6">
                <!-- Student Image and Name -->
                <div class="flex flex-col items-center mb-3">
                    <img id="studentImageTC" src="" alt="Student Image"
                        class="student-image w-32 h-32 rounded-full mb-2" loading="lazy">

                    <h3 id="studentNameTC" data-student-session-id="" class="text-2xl font-bold text-white text-center"></h3>
                    <p id="fatherNameTC" class="text-gray-400 text-center"></p>
                </div>

                <!-- Details Table -->
                <div class="bg-gray-700 rounded-xl p-4 mb-5">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-gray-300 font-medium">Old Class</span>
                            <span id="oldClassTC" class="text-white font-semibold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300 font-medium">New Class</span>
                            <span id="newClassTC" class="text-accent-green font-semibold"></span>
                        </div>
                    </div>
                </div>

                <!-- Input Fields -->
                <div class="space-y-4">
                    <div>
                        <label for="leavingReason" class="block text-gray-300 mb-2 font-medium">Leaving Reason <span
                                class="text-red-400">*</span></label>
                        <input type="text" id="leavingReason" name="leavingReason" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter leaving reason" list="leavingReasonList">
                        <datalist id="leavingReasonList">
                            <option value="Completed the studies"></option>
                            <option value="Parent's Wish"></option>
                            <option value="Transfer to another school"></option>
                            <option value="Due to Relocation"></option>
                            <option value="Due to Financial reasons"></option>
                        </datalist>
                        <p id="leavingReasonError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="generalConduct" class="block text-gray-300 mb-2 font-medium">General Conduct <span
                                class="text-red-400">*</span></label>
                        <input type="text" id="generalConduct" name="generalConduct" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter general conduct" list="generalConductList">
                        <datalist id="generalConductList">
                            <option value="Very Good"></option>
                            <option value="Excellent"></option>
                            <option value="Good"></option>
                            <option value="Satisfactory"></option>
                            <option value="Needs Improvement"></option>
                        </datalist>
                        <p id="generalConductError" class="error-message hidden" style="color: red;"></p>
                    </div>

                    <div>
                        <label for="leavingDate" class="block text-gray-300 mb-2 font-medium">Leaving Date <span
                                class="text-red-400">*</span></label>
                        <input type="date" id="leavingDate" name="leavingDate" required
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200">
                        <p id="dateError" class="error-message hidden" style="color: red;"></p>
                    </div>


                    <div>
                        <label for="otherRemark" class="block text-gray-300 mb-2 font-medium">Any Remarks?</label>
                        <input type="text" id="otherRemark" name="otherRemark"
                            class="w-full bg-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent-green focus:border-accent-green transition-colors duration-200"
                            placeholder="Enter any remark (if any)">
                        <p id="otherRemarkError" class="error-message hidden" style="color: red;"></p>
                    </div>
                </div>
            </form>
        </div>
        <!-- Modal Footer -->
        <div class="bg-gray-700 rounded-b-lg border-t border-gray-600 px-6 py-3 flex flex-wrap gap-3 justify-between">

            <!-- Close button on the left -->
            <div>
                <button type="button"
                    class="px-3 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-medium transition-colors duration-200"
                    onclick="closeTCModal()">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>

            <!-- Action buttons on the right -->
            <div class="flex flex-wrap gap-3" id="tc-modal-footer">
                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200 hidden"
                    id="tc-messageButton">
                    <i class="fas fa-whatsapp mr-2"></i>
                    Send Message
                </button>

                <button type="button"
                    class="px-4 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium transition-colors duration-200"
                    id="tc-generateButton">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Generate TC
                </button>
            </div>
        </div>

    </div>
</div>



<script src="{{ url_for('static', filename='watsappMessage.js') }}"></script>
<script>
    const stateLabels = {
        "PROMOTED": "Promoted",
        "TC_ISSUED": "TC Issued",
        "NOT_PROMOTED_NOT_TC": "No Action"
    };

    const placeholderBoy = "{{ url_for('static', filename='no-student-boy-image.png') }}";
    const placeholderGirl = "{{ url_for('static', filename='no-student-girl-image.png') }}";

    let students = [];
    let activeFilter = "ALL";

    const stateColors = {
        PROMOTED: "bg-emerald-500/20 text-emerald-300 border border-emerald-500/50",
        TC_ISSUED: "bg-amber-500/20 text-amber-300 border border-amber-500/50",
        NOT_PROMOTED_NOT_TC: "bg-slate-500/20 text-slate-200 border border-slate-500/50"
    };

    function updateStateBadgeCounts() {
        const promoted = students.filter(s => s.state === "PROMOTED").length;
        const tc = students.filter(s => s.state === "TC_ISSUED").length;
        const none = students.filter(s => s.state === "NOT_PROMOTED_NOT_TC").length;
        const all = students.length;

        const promotedBadge = document.getElementById("badge-promoted-count");
        const tcBadge = document.getElementById("badge-tc-count");
        const noneBadge = document.getElementById("badge-none-count");
        const allBadge = document.getElementById("badge-all-count");

        if (promotedBadge) promotedBadge.textContent = promoted;
        if (tcBadge) tcBadge.textContent = tc;
        if (noneBadge) noneBadge.textContent = none;
        if (allBadge) allBadge.textContent = all;
    }

    function applyStateFilter(state) {
        activeFilter = state;
        renderStudentCards();
        document.querySelectorAll("[data-filter-button]").forEach(btn => {
            btn.classList.toggle("bg-blue-600", btn.dataset.filterButton === state);
            btn.classList.toggle("text-white", btn.dataset.filterButton === state);
            btn.classList.toggle("bg-gray-700", btn.dataset.filterButton !== state);
        });
    }

    function updateStudentsList(list) {
        students = Array.isArray(list) ? list : [];
        updateStateBadgeCounts();
        renderStudentCards();
    }

    function buildStudentStateBadge(state) {
        const label = stateLabels[state] || "No Action";
        const color = stateColors[state] || stateColors.NOT_PROMOTED_NOT_TC;
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-2 ${color}">
                    <span class="h-2 w-2 rounded-full bg-current"></span>${label}
                </span>`;
    }

    function buildStudentActionButtons(student) {
        const baseBtn = "flex-1 py-2 rounded-lg font-medium transition-colors flex items-center justify-center text-white";
        if (student.state === "PROMOTED") {
            return `
                <button class="${baseBtn} bg-blue-700 hover:bg-blue-600" onclick="openUpdatePromotionModal('${student.promoted_session_id}')">
                    <i class="fas fa-sync-alt mr-2"></i> Update
                </button>
                <button class="${baseBtn} bg-red-700 hover:bg-red-600" onclick="openDepromotionModal('${student.promoted_session_id}')">
                    <i class="fas fa-undo mr-2"></i> De-Promote
                </button>
            `;
        }
        if (student.state === "TC_ISSUED") {
            return `
                <button class="${baseBtn} bg-green-700 hover:bg-green-600" onclick="reprintIssuedTC('${student.student_session_id}')">
                    <i class="fas fa-file-alt mr-2"></i> Get TC
                </button>
                <button class="${baseBtn} bg-yellow-700 hover:bg-yellow-600" onclick="submitTCRevert('${student.student_session_id}')">
                    <i class="fas fa-redo mr-2"></i> Redo
                </button>
            `;
        }
        const disabled = !student.next_class ? 'disabled style="opacity:0.6;cursor:not-allowed;"' : "";
        const promoteLabel = student.next_class ? "Promote" : "No Classes";
        return `
            <button class="${baseBtn} bg-green-700 hover:bg-green-600" onclick="openPromotionModalForStudent('${student.id}')" ${disabled}>
                <i class="fas fa-graduation-cap mr-2"></i>${promoteLabel}
            </button>
            <button class="${baseBtn} bg-amber-700 hover:bg-amber-600" onclick="openTCCreationModal('${student.id}')">
                <i class="fas fa-file-alt mr-2"></i> Create TC
            </button>
        `;
    }

    function buildStudentCard(student) {
        const stateBadge = buildStudentStateBadge(student.state);
        const promotedInfo = student.state === "PROMOTED" ? `
            <div class="flex justify-between text-green-300">
                <span>Class (Now):</span><span class="font-medium">${student.next_class}</span>
            </div>
            <div class="flex justify-between text-green-300">
                <span>Roll (Now):</span><span class="font-medium">${student.next_roll || "-"}</span>
            </div>` : "";
        const tcInfo = student.state === "TC_ISSUED" ? `
            <div class="flex justify-between text-amber-300">
                <span>TC No:</span><span class="font-medium">${student.tc_number || "-"}</span>
            </div>
            <div class="flex justify-between text-amber-300">
                <span>TC Date:</span><span class="font-medium">${student.tc_date || "-"}</span>
            </div>` : "";

        const imageSrc = student.IMAGE
            ? `https://lh3.googleusercontent.com/d/${student.IMAGE}=s200`
            : (student.GENDER === 'Male' ? placeholderBoy : placeholderGirl);

        return `
        <div class="student-card rounded-2xl overflow-hidden shadow-lg card-hover" data-name="${student.STUDENTS_NAME}"
            data-roll="${student.previous_roll || ''}">
            <div class="p-6 space-y-4">
                <div class="flex items-start gap-3">
                    <img src="${imageSrc}"
                        alt="Student Image" class="student-image mt-2" loading="lazy">
                    <div class="flex-1 min-w-0 space-y-2">
                        <div class="flex items-center justify-between gap-2">
                            <h3 class="font-bold text-lg text-green-400 truncate">${student.STUDENTS_NAME}</h3>
                            ${stateBadge}
                        </div>
                        <p class="text-sm text-gray-400">
                            <span class="font-medium">C/O:</span> ${student.FATHERS_NAME || "-"}
                        </p>
                        <div class="mt-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Old Class:</span>
                                <span class="font-medium text-white">${student.previous_class}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Old Roll No:</span>
                                <span class="font-medium text-white">${student.previous_roll || "-"}</span>
                            </div>
                            ${promotedInfo}
                            ${tcInfo}
                        </div>
                    </div>
                </div>
                <div class="mt-2 flex gap-3">
                    ${buildStudentActionButtons(student)}
                </div>
            </div>
        </div>`;
    }

    function renderStudentCards() {
        const container = document.getElementById("StudentData");
        if (!container) return;
        const term = document.getElementById("search-input").value.trim().toLowerCase();
        const filtered = students.filter((s) => {
            const matchesFilter = activeFilter === "ALL" || s.state === activeFilter;
            const matchesSearch =
                s.STUDENTS_NAME.toLowerCase().includes(term) ||
                (s.previous_roll && String(s.previous_roll).toLowerCase().includes(term));
            return matchesFilter && matchesSearch;
        });

        container.innerHTML = filtered.map(buildStudentCard).join("");
        document.getElementById("noResults").classList.toggle("hidden", filtered.length !== 0);
    }

    async function fetchStudentsByClass(classId) {
        document.getElementById("search-input").value = "";
        const res = await fetch('/api/promote/students-by-class', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ class_id: classId })
        });
        const data = await res.json();
        console.log(data)
        if (res.ok) {
            updateStudentsList(data.students || []);
        } else {
            showAlert(res.status, data.message || "Unable to load students");
        }
    }

    function setFooterButtons({ promote = false, update = false, depromote = false, message = false, depromoteCheckbox = false }) {
        const footer = document.getElementById("modal-footer");
        footer.querySelector('#promoteButton').classList.toggle("hidden", !promote);
        footer.querySelector('#updateButton').classList.toggle("hidden", !update);
        footer.querySelector('#depromoteButton').classList.toggle("hidden", !depromote);
        footer.querySelector('#messageButton').classList.toggle("hidden", !message);
        document.getElementById('depromoteCheckboxContainer').classList.toggle('hidden', !depromoteCheckbox);
    }

    async function updateRollForClass() {
        const classId = document.getElementById("promotedClass").value;
        const availableRollsEl = document.getElementById("availableRolls");
        const newRollEl = document.getElementById("newRoll");
        if (!classId) {
            availableRollsEl.textContent = "Available rolls: Select a class first";
            newRollEl.value = "";
            return;
        }
        try {
            const res = await fetch('/api/promote/get-available-rolls', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ class_id: classId }),
            });
            const data = await res.json();
            if (res.ok) {
                availableRollsEl.textContent = `Available rolls: ${data.available_rolls.join(', ')}`;
                newRollEl.value = data.next_roll;
            } else {
                availableRollsEl.textContent = "Available rolls: Error loading";
                newRollEl.value = "";
            }
        } catch (err) {
            console.error(err);
            availableRollsEl.textContent = "Available rolls: Error loading";
            newRollEl.value = "";
        }
    }

    async function openPromotionModalForStudent(studentID) {
        try {
            const res = await fetch('/api/promote/student-promotion-data', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'student_id': studentID }),
            });
            const data = await res.json();
            if (!res.ok) return showAlert(res.status, data.message);

            document.getElementById("modalTitle").innerText = "Promote Student";
            document.getElementById("studentName").innerText = data.STUDENTS_NAME;
            document.getElementById("studentName").setAttribute("data-id", data.id);
            document.getElementById("oldClass").innerText = `${data.CLASS} | Roll: ${data.ROLL}`;
            document.getElementById("promotion_date").value = data.promoted_date;
            document.getElementById("father").innerText = data.FATHERS_NAME;
            document.getElementById("studentImage").src = data.IMAGE
                ? 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200'
                : 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';

            // Populate class dropdown
            const classSelect = document.getElementById("promotedClass");
            classSelect.innerHTML = '<option value="">Select Class</option>';
            if (data.available_classes && data.available_classes.length > 0) {
                data.available_classes.forEach(cls => {
                    const option = document.createElement("option");
                    option.value = cls.id;
                    option.textContent = cls.name;
                    if (cls.id === data.promoted_class_id) {
                        option.selected = true;
                    }
                    classSelect.appendChild(option);
                });
            }

            // Add event listener for class change
            classSelect.addEventListener('change', updateRollForClass);

            // Update roll for initially selected class
            await updateRollForClass();

            setFooterButtons({ promote: true });
            const promoteButton = document.getElementById("promoteButton");
            promoteButton.setAttribute("onclick", `submitPromotion('${data.id}')`);
            openPromotionModal();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }

    async function openUpdatePromotionModal(studentSessionID) {
        try {
            const res = await fetch('/api/promote/promoted-student-data', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'studentSessionID': studentSessionID }),
            });
            const data = await res.json();

            if (!res.ok) return showAlert(res.status, data.message);

            document.getElementById("modalTitle").innerText = "Update Student";
            document.getElementById("studentName").innerText = data.STUDENTS_NAME;
            document.getElementById("studentName").setAttribute("data-id", data.id);
            document.getElementById("oldClass").innerText = `${data.CLASS} | Roll: ${data.ROLL}`;
            document.getElementById("promotion_date").value = data.promoted_date;
            document.getElementById("father").innerText = data.FATHERS_NAME;
            document.getElementById("studentImage").src = data.IMAGE
                ? 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200'
                : 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';

            // Populate class dropdown
            const classSelect = document.getElementById("promotedClass");
            classSelect.innerHTML = '<option value="">Select Class</option>';
            if (data.available_classes && data.available_classes.length > 0) {
                data.available_classes.forEach(cls => {
                    const option = document.createElement("option");
                    option.value = cls.id;
                    option.textContent = cls.name;
                    if (cls.id === data.promoted_class_id) {
                        option.selected = true;
                    }
                    classSelect.appendChild(option);
                });
            }

            // Add event listener for class change
            classSelect.addEventListener('change', updateRollForClass);

            // Set current roll as selected (will be updated if class changes)
            document.getElementById("newRoll").value = data.promoted_roll;

            // Update available rolls for current class
            await updateRollForClass();

            setFooterButtons({ update: true });
            document.getElementById("updateButton").setAttribute("onclick", `submitPromotionUpdate('${data.promoted_session_id}')`);
            openPromotionModal();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }

    async function openDepromotionModal(studentSessionID) {
        try {
            const res = await fetch('/api/promote/promoted-student-data', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'studentSessionID': studentSessionID }),
            });
            const data = await res.json();
            if (!res.ok) return showAlert(res.status, data.message);

            document.getElementById("modalTitle").innerText = "Depromote Student";
            document.getElementById("studentName").innerText = data.STUDENTS_NAME;
            document.getElementById("studentName").setAttribute("data-id", data.id);
            document.getElementById("oldClass").innerText = `${data.CLASS} | Roll: ${data.ROLL}`;
            document.getElementById("father").innerText = data.FATHERS_NAME;

            // Hide and disable class dropdown for depromotion
            const classSelect = document.getElementById("promotedClass");
            classSelect.innerHTML = '<option value="">N/A</option>';
            classSelect.disabled = true;
            classSelect.style.display = 'none';
            classSelect.closest('div').style.display = 'none';

            document.getElementById("newRoll").value = data.promoted_roll;
            document.getElementById("newRoll").disabled = true;
            document.getElementById("promotion_date").value = data.promoted_date;
            document.getElementById("promotion_date").disabled = true;

            document.getElementById("studentImage").src = data.IMAGE
                ? 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200'
                : 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';

            setFooterButtons({ depromote: true, depromoteCheckbox: true });
            document.getElementById("depromoteButton").setAttribute("onclick", `submitDepromotion('${data.promoted_session_id}')`);
            openPromotionModal();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }

    async function openTCCreationModal(studentID) {
        try {
            const res = await fetch('/api/promote/student-promotion-data', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'student_id': studentID }),
            });

            const data = await res.json();
            if (!res.ok) return showAlert(res.status, data.message);

            document.getElementById("tc-modalTitle").innerText = "Generate TC";
            document.getElementById("studentNameTC").innerText = data.STUDENTS_NAME;
            document.getElementById("studentNameTC").setAttribute("data-student-session-id", data.student_session_id);
            document.getElementById("leavingDate").value = data.promoted_date;
            document.getElementById("oldClassTC").innerText = `${data.CLASS} | Roll: ${data.ROLL}`;
            document.getElementById("newClassTC").innerText = data.promoted_class;
            document.getElementById("fatherNameTC").innerText = data.FATHERS_NAME;

            document.getElementById("studentImageTC").src = data.IMAGE
                ? 'https://lh3.googleusercontent.com/d/' + data.IMAGE + '=s200'
                : 'https://cdn.pixabay.com/photo/2016/04/22/04/57/graduation-1345143_1280.png';

            const tc_modal_footer = document.getElementById("tc-modal-footer");
            tc_modal_footer.querySelector("#tc-messageButton").classList.add("hidden");
            tc_modal_footer.querySelector("#tc-generateButton").classList.remove("hidden");

            const generateTCButton = tc_modal_footer.querySelector("#tc-generateButton");
            generateTCButton.onclick = () => {
                const leavingReason = document.getElementById("leavingReason").value;
                const leavingDate = document.getElementById("leavingDate").value;
                const generalConduct = document.getElementById("generalConduct").value;
                const otherRemarks = document.getElementById("otherRemark").value;
                submitTCGeneration(data.student_session_id, leavingReason, leavingDate, generalConduct, otherRemarks);
            };

            const modal = document.getElementById('studenttcModal');
            modal.classList.remove("modal-hidden");
            document.body.style.overflow = "hidden";
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        }
    }

    async function submitPromotion(studentID) {
        const form = document.getElementById("promotionForm");
        const formData = new FormData(form);

        const btn = document.getElementById("promoteButton");
        const spinner = document.getElementById("promoteSpinner");

        const promoted_class_id = document.getElementById("promotedClass").value;
        if (!promoted_class_id) {
            showAlert(400, "Please select a class to promote to.");
            return;
        }

        btn.disabled = true;
        spinner.classList.remove("hidden");

        const promoted_date = formData.get("promotion_date");
        const promoted_roll = formData.get("newRoll");

        try {
            const res = await fetch("/api/promote/student", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'student_id': studentID, 'promoted_date': promoted_date,
                    'promoted_roll': promoted_roll, 'promoted_class_id': promoted_class_id,
                }),
            });

            const data = await res.json();

            if (res.ok) {
                updateStudentInLocalState(studentID, {
                    state: "PROMOTED",
                    promoted_session_id: data.promoted_session_id,
                    next_roll: data.next_roll,
                    promoted_date: data.created_at
                });

                const response = await fetch('/api/promote/promotion-message', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 'student_id': studentID }),
                });

                const generate_message = await response.json();

                if (generate_message.PHONE && generate_message.whatsappMessage && response.ok) {
                    const footer = document.getElementById("modal-footer");
                    const messageButton = document.getElementById("messageButton");

                    setFooterButtons({ message: true });
                    messageButton.setAttribute("onclick", `sendWhatsAppMessage('${generate_message.PHONE}', \`${generate_message.whatsappMessage}\`)`);
                    messageButton.disabled = false;
                } else {
                    closeModal();
                }
            }
            showAlert(res.status, data.message);
            renderStudentCards();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("hidden");
            btn.disabled = false;
        }
    }

    async function submitPromotionUpdate(studentSessionID) {
        const form = document.getElementById("promotionForm");
        const formData = new FormData(form);

        const btn = document.getElementById("promoteButton");
        const spinner = document.getElementById("promoteSpinner");

        const promoted_class_id = document.getElementById("promotedClass").value;
        if (!promoted_class_id) {
            showAlert(400, "Please select a class.");
            return;
        }

        btn.disabled = true;
        spinner.classList.remove("hidden");

        const promoted_date = formData.get("promotion_date");
        const promoted_roll = formData.get("newRoll");

        try {
            const res = await fetch("/api/promote/update-promotion", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'student_session_id': studentSessionID, 'promoted_date': promoted_date,
                    'promoted_roll': promoted_roll, 'promoted_class_id': promoted_class_id,
                }),
            });

            const data = await res.json();

            if (res.ok) {
                const studentId = document.getElementById("studentName").getAttribute("data-id");
                updateStudentInLocalState(studentId, {
                    next_roll: data.next_roll,
                    promoted_date: data.created_at,
                    next_class: data.new_class
                });
                closeModal();
            }

            showAlert(res.status, data.message);
            renderStudentCards();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("hidden");
            btn.disabled = false;
        }
    }

    async function submitDepromotion(studentSessionID) {
        const isChecked = document.getElementById('depromoteCheckbox').checked;
        if (!isChecked) {
            showAlert(400, "Please check the checkbox to confirm depromotion.");
            return;
        }

        const btn = document.getElementById("depromoteButton");
        const spinner = document.getElementById("depromoteSpinner");

        btn.disabled = true;
        spinner.classList.remove("hidden");

        try {
            const res = await fetch("/api/promote/depromote-student", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'promoted_session_id': studentSessionID }),
            });

            const data = await res.json();

            if (res.ok) {
                const studentId = document.getElementById("studentName").getAttribute("data-id");
                updateStudentInLocalState(studentId, {
                    state: "NOT_PROMOTED_NOT_TC",
                    promoted_session_id: null,
                    next_roll: null
                });
                closeModal();
            }
            showAlert(res.status, data.message);
            renderStudentCards();
        } catch (err) {
            console.error(err);
            showAlert(400, "An unexpected error occurred. Please try again.");
        } finally {
            spinner.classList.add("hidden");
            btn.disabled = false;
        }
    }

    async function submitTCGeneration(studentSessionId, leavingReason, leavingDate, generalConduct, otherRemarks = "") {
        if (!leavingReason) return showAlert(400, "Please select a reason for leaving.");
        if (!leavingDate) return showAlert(400, "Please select a leaving date.");
        if (!generalConduct) return showAlert(400, "Please provide general conduct remarks.");

        try {
            const resp = await fetch("/api/tc/generate-and-save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    student_session_id: studentSessionId,
                    leavingReason,
                    leavingDate,
                    generalConduct,
                    otherRemarks
                }),
            });

            const content = await resp.json();

            if (!resp.ok) {
                showAlert(resp.status, content.message);
                return;
            }

            updateStudentInLocalState(studentSessionId, {
                state: "TC_ISSUED",
                tc_date: content.tc_date,
                tc_number: content.tc_number,
                left_reason: content.left_reason
            });
            renderStudentCards();
            closeTCModal();

            const printWindow = window.open("", "_blank");
            if (!printWindow) {
                showAlert(400, "Unable to open print window");
                return;
            }

            printWindow.document.open();
            printWindow.document.write(content.html);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        } catch (err) {
            console.error(err);
            showAlert(400, "Unable to generate TC.");
        }
    }

    async function submitTCRevert(studentSessionId) {
        try {
            const res = await fetch("/api/tc/revert", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_session_id: studentSessionId })
            });
            const data = await res.json();
            if (!res.ok) return showAlert(res.status, data.message);
            updateStudentInLocalState(studentSessionId, {
                state: "NOT_PROMOTED_NOT_TC",
                tc_date: null,
                tc_number: null,
                left_reason: null
            });
            renderStudentCards();
            showAlert(res.status, data.message);
        } catch (error) {
            console.error(error);
            showAlert(400, "Unable to revert TC.");
        }
    }

    async function reprintIssuedTC(studentSessionId) {
        try {
            const resp = await fetch("/api/tc/reprint", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_session_id: studentSessionId }),
            });

            const content = await resp.json();

            if (!resp.ok) {
                showAlert(resp.status, content.message);
                return;
            }

            const printWindow = window.open("", "_blank");
            if (!printWindow) {
                showAlert(400, "Unable to open print window");
                return;
            }

            printWindow.document.open();
            printWindow.document.write(content.html);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        } catch (err) {
            console.error(err);
            showAlert(400, "Unable to reprint TC.");
        }
    }

    function updateStudentInLocalState(studentSessionId, payload) {
        const idx = students.findIndex(s => String(s.student_session_id) === String(studentSessionId) || String(s.id) === String(studentSessionId));
        if (idx === -1) return;
        students[idx] = { ...students[idx], ...payload };
        updateStateBadgeCounts();
    }

    function openPromotionModal() {
        const modal = document.getElementById('studentPromotionModal');
        modal.classList.remove("modal-hidden");
        document.body.style.overflow = "hidden";
    }

    function closeModal() {
        const modal = document.getElementById('studentPromotionModal');
        modal.classList.add("modal-hidden");
        document.body.style.overflow = "";
        document.getElementById("promotionForm").reset();
        document.getElementById("newRoll").disabled = false;
        document.getElementById("promotion_date").disabled = false;
        const classSelect = document.getElementById("promotedClass");
        classSelect.innerHTML = '<option value="">Select Class</option>';
        classSelect.disabled = false;
        classSelect.style.display = '';
        classSelect.closest('div').style.display = '';
        classSelect.removeEventListener('change', updateRollForClass);
    }

    function closeTCModal() {
        const modal = document.getElementById('studenttcModal');
        modal.classList.add("modal-hidden");
        document.body.style.overflow = "";
    }

    document.getElementById('closeModal').addEventListener("click", closeModal);
    document.getElementById('studentPromotionModal').addEventListener("click", (e) => {
        if (!document.getElementById('modalContent').contains(e.target)) {
            closeModal();
        }
    });

    function applyFilters() {
        renderStudentCards();
    }

    document.getElementById("classView").addEventListener("change", () => {
        document.getElementById("search-input").value = "";
        const classId = document.getElementById("classView").value;
        if (classId) {
            fetchStudentsByClass(classId);
        }
    });

    document.querySelectorAll("[data-filter-button]").forEach(btn => {
        btn.addEventListener("click", () => applyStateFilter(btn.dataset.filterButton));
    });

    // Set default filter visual state
    applyStateFilter("ALL");
    updateStateBadgeCounts();
</script>

{% endblock %}
