{% extends "base.html" %}
{% block title %}{{ paper.event }} - Question Paper Editor{% endblock %}
{% block content %}

<div class="min-h-screen">
  <!-- Animated Background -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div
      class="absolute top-20 left-10 w-64 h-64 bg-primary/10 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse">
    </div>
    <div
      class="absolute bottom-20 right-10 w-64 h-64 bg-secondary/10 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse animation-delay-2000">
    </div>
  </div>

  <!-- Main Container -->
  <div class="relative max-w-7xl mx-auto py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-8">
        <div class="flex items-center gap-4">
          <a href="/question-papers"
            class="group relative p-2 bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-xl hover:border-primary transition-all duration-300 hover:scale-105">
            <i class="fas fa-arrow-left text-gray-400 group-hover:text-primary transition"></i>
          </a>
          <div>
            <h1
              class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
              {{ paper.event }}
            </h1>
            <p class="text-gray-400 mt-2">Edit and customize your question paper</p>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-xl p-3">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-primary/20 rounded-lg">
                <i class="fas fa-book text-primary"></i>
              </div>
              <div>
                <p class="text-sm text-gray-400">Subject</p>
                <p class="text-white font-semibold">{{ paper.subject }}</p>
              </div>
            </div>
          </div>
          <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-xl p-3">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-secondary/20 rounded-lg">
                <i class="fas fa-users text-secondary"></i>
              </div>
              <div>
                <p class="text-sm text-gray-400">Class</p>
                <p class="text-white font-semibold">{{ paper.class_name }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left Sidebar - Paper Details -->
      <div class="lg:col-span-1">
        <div class="sticky top-8 space-y-6">
          <!-- Paper Details Card -->
          <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-primary/20 to-secondary/20 border-b border-gray-700 px-6 py-4">
              <h2 class="text-lg font-bold text-white flex items-center gap-3">
                <i class="fas fa-file-alt text-primary"></i>
                Paper Details
              </h2>
            </div>

            <div class="p-6 space-y-5">
              <div>
                <label class="block text-sm font-semibold text-white mb-2">Event/Assessment</label>
                <div class="relative">
                  <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" id="event"
                    class="pl-10 w-full bg-darkbg/50 text-white border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                    placeholder="Formative Assessment - I" value="{{ paper.event }}">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-white mb-2">Subject</label>
                <div class="relative">
                  <i class="fas fa-book absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" id="subject"
                    class="pl-10 w-full bg-darkbg/50 text-white border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                    placeholder="Mathematics" value="{{ paper.subject }}">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-white mb-2">Class/Grade</label>
                <div class="relative">
                  <i class="fas fa-graduation-cap absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" id="class"
                    class="pl-10 w-full bg-darkbg/50 text-white border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                    placeholder="Class 10A" value="{{ paper.class_name }}">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-white mb-2">Duration</label>
                  <div class="relative">
                    <i class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="duration"
                      class="pl-10 w-full bg-darkbg/50 text-white border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                      placeholder="2 Hrs" value="{{ paper.duration }}">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-white mb-2">Total Marks</label>
                  <div class="relative">
                    <i class="fas fa-star absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="number" id="marks"
                      class="pl-10 w-full bg-darkbg/50 text-white border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                      placeholder="100" value="{{ paper.marks }}">
                  </div>
                </div>
              </div>

              <!-- Auto-save indicator -->
              <div id="autoSaveIndicator"
                class="hidden text-center py-2 bg-success/10 border border-success/20 rounded-lg">
                <p class="text-success text-sm flex items-center justify-center gap-2">
                  <i class="fas fa-check-circle"></i>
                  Changes saved
                </p>
              </div>
            </div>
          </div>

          <!-- Font Size Control Card -->
          <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-primary/20 to-secondary/20 border-b border-gray-700 px-6 py-4">
              <h2 class="text-lg font-bold text-white flex items-center gap-3">
                <i class="fas fa-text-height text-primary"></i>
                Print Settings
              </h2>
            </div>

            <div class="p-6">
              <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                  <label class="text-sm font-semibold text-white">Font Size</label>
                  <span id="fontSizeDisplay"
                    class="bg-primary/20 text-primary font-bold px-3 py-1 rounded-lg">20px</span>
                </div>
                <input type="range" id="customRange" min="10" max="30" step="1" value="20"
                  class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-lg"
                  oninput="updateRangeValue(this.value)">
              </div>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl p-6">
            <h3 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fas fa-chart-bar text-primary"></i>
              Paper Stats
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Total Questions</span>
                <span id="totalQuestions" class="text-white font-bold">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Sections</span>
                <span id="totalSections" class="text-white font-bold">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Total Marks</span>
                <span class="text-white font-bold">{{ paper.marks }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Editor Area -->
      <div class="lg:col-span-3">
        <!-- Questions Section Header -->
        <div class="mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-white mb-2">Questions</h2>
              <p class="text-gray-400">Add and organize questions for your paper</p>
            </div>

            <div class="flex gap-3">
              <button onclick="showQuestionTypeModal()"
                class="group relative overflow-hidden bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 flex items-center gap-2">
                <div
                  class="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
                </div>
                <i class="fas fa-plus"></i>
                Add Section
              </button>
            </div>
          </div>
        </div>

        <!-- Questions Container -->
        <div id="content" class="space-y-6">
          <!-- Default section will be added here by JavaScript -->
        </div>

        <!-- Bottom Action Buttons -->
        <div class="mt-8 pt-8 border-t border-gray-700">
          <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="convertToPDF()"
              class="group relative overflow-hidden bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 flex-1 flex items-center justify-center gap-3">
              <div
                class="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
              </div>
              <i class="fas fa-file-pdf"></i>
              Generate PDF
            </button>

            <button onclick="savePaper()"
              class="group relative overflow-hidden bg-gradient-to-r from-success to-emerald-600 hover:from-success/90 hover:to-emerald-500 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 flex-1 flex items-center justify-center gap-3">
              <div
                class="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
              </div>
              <i class="fas fa-save"></i>
              Save Paper
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast"
  class="hidden fixed bottom-4 right-4 bg-gray-800/90 backdrop-blur-sm text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 z-40 border border-gray-700 transform transition-all duration-300 translate-y-full">
  <div id="toastIcon"></div>
  <span id="toastMessage"></span>
</div>

<!-- Floating Save Indicator -->
<div id="saveIndicator"
  class="hidden fixed bottom-4 left-4 bg-gray-800/90 backdrop-blur-sm text-white px-4 py-2 rounded-lg shadow-lg z-40 border border-gray-700 flex items-center gap-2">
  <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
  <span class="text-sm">Auto-saving...</span>
</div>


<!-- Loading Overlay -->
<div id="loadingOverlay"
  class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-navbg border border-gray-700 rounded-2xl p-8 flex flex-col items-center gap-4">
    <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
    <p class="text-white font-semibold">Processing...</p>
  </div>
</div>

<script>
  // Configuration
  const paperId = {{ paper.id }};
  const QUESTION_TYPE_LABELS = {
    "mcq": "Multiple Choice Questions",
    "fillUp": "Fill In The Blanks",
    "match": "Match the Following",
    "QnA": "Question & Answers",
    "TF": "True or False",
    "singleWord": "Single Word/Term"
  };

  let state = {
    meta: {
      event: '{{ paper.event }}',
      subject: '{{ paper.subject }}',
      std: '{{ paper.class_name }}',
      hrs: '{{ paper.duration }}',
      MM: '{{ paper.marks }}',
      fontSize: 20
    },
    questions: []
  };

  let autoSaveTimer = null;
  let sectionCounter = 1;

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await loadPaperData();
    initEventListeners();
    initAutoSave();

    // Add default section if no sections exist
    if (document.querySelectorAll('.question-section').length === 0) {
      addQuestionType('mcq');
    }
  });

  // Initialize event listeners
  function initEventListeners() {
    // Input listeners for auto-save
    ['event', 'subject', 'class', 'duration', 'marks'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', debounce(saveCurrentState, 1000));
      }
    });

    // Font size slider
    document.getElementById('customRange').addEventListener('input', (e) => {
      updateRangeValue(e.target.value);
      saveCurrentState();
    });

    // Enable typing in all inputs using event delegation
    document.addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        saveCurrentState();
      }
    });
  }

  // Initialize auto-save
  function initAutoSave() {
    // Auto-save every 30 seconds
    setInterval(() => {
      if (state.questions.length > 0) {
        autoSavePaper();
      }
    }, 30000);
  }

  // Load paper data
  async function loadPaperData() {
    showLoading();
    try {
      const response = await fetch(`/question-papers/api/${paperId}`);
      const data = await response.json();

      if (data && data.paper_data) {
        renderJson(data.paper_data);
        updateStats();
      }
      hideLoading();
    } catch (error) {
      console.error('Error loading paper:', error);
      showToast('Error loading paper data', 'error');
      hideLoading();
    }
  }

  // Utility Functions
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastMessage = document.getElementById('toastMessage');

    let icon = '';
    switch (type) {
      case 'success':
        icon = '<i class="fas fa-check-circle text-success"></i>';
        break;
      case 'error':
        icon = '<i class="fas fa-exclamation-circle text-danger"></i>';
        break;
      case 'info':
        icon = '<i class="fas fa-info-circle text-primary"></i>';
        break;
    }

    toastIcon.innerHTML = icon;
    toastMessage.textContent = message;

    toast.classList.remove('hidden', 'translate-y-full');
    toast.classList.add('translate-y-0');

    setTimeout(() => {
      toast.classList.remove('translate-y-0');
      toast.classList.add('translate-y-full');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 300);
    }, 3000);
  }

  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function showAutoSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.remove('hidden');
    setTimeout(() => indicator.classList.add('hidden'), 2000);
  }

  function updateRangeValue(value) {
    document.getElementById('fontSizeDisplay').textContent = value + 'px';
  }

  function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function generateQuestionId() {
    return 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  function getQuestionTemplate(type, questionData = {}) {
    const id = questionData.id || generateQuestionId();
    const questionNo = sectionCounter++;
    const title = questionData.qText || QUESTION_TYPE_LABELS[type] || 'Question Section';
    const marks = questionData.marks || '';

    let questionContent = '';

    switch (type) {
      case 'mcq':
        questionContent = getMCQTemplate(questionData.subQuestion || [{}]);
        break;
      case 'QnA':
        questionContent = getQnATemplate(questionData.subQuestion || ['']);
        break;
      case 'fillUp':
        questionContent = getFillUpTemplate(questionData.subQuestion || ['']);
        break;
      case 'TF':
        questionContent = getTFTemplate(questionData.subQuestion || ['']);
        break;
      case 'match':
        questionContent = getMatchTemplate(questionData.subQuestion || [''], questionData.options || ['']);
        break;
      case 'singleWord':
        questionContent = getSingleWordTemplate(questionData.subQuestion || ['']);
        break;
      default:
        questionContent = '<div class="text-center py-4 text-gray-500">Select a question type</div>';
    }

    return `
      <div class="question-section" data-id="${id}" data-type="${type}">
        <div class="bg-navbg/50 backdrop-blur-sm border border-gray-700 rounded-2xl overflow-hidden transition-all duration-300 hover:border-primary">
          <!-- Question Header -->
          <div class="bg-gradient-to-r from-primary/10 to-secondary/10 border-b border-gray-700 px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
              <!-- Left: Question number and info -->
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 flex items-center justify-center bg-primary/20 rounded-lg flex-shrink-0">
                  <span class="text-primary font-bold">${questionNo}</span>
                </div>
                <div class="min-w-0"> <!-- allows truncation if needed -->
                  <h3 class="text-base sm:text-lg font-bold text-white truncate">Section ${questionNo}: ${title}</h3>
                  <p class="text-gray-400 text-xs sm:text-sm">${QUESTION_TYPE_LABELS[type] || 'Question Section'}</p>
                </div>
              </div>

              <!-- Right: Controls (type selector + action buttons) -->
              <div class="flex flex-wrap items-center gap-2">
                <!-- Type selector - FIXED: solid dark background -->
                <div class="relative flex-1 sm:flex-none min-w-[140px]">
                  <select class="question-type-select w-full bg-gray-800 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition hover:bg-gray-700"
                          onchange="changeQuestionType('${id}', this.value)">
                    <option value="mcq" ${type === 'mcq' ? 'selected' : ''}>MCQ</option>
                    <option value="QnA" ${type === 'QnA' ? 'selected' : ''}>Q&A</option>
                    <option value="fillUp" ${type === 'fillUp' ? 'selected' : ''}>Fill Ups</option>
                    <option value="TF" ${type === 'TF' ? 'selected' : ''}>True/False</option>
                    <option value="match" ${type === 'match' ? 'selected' : ''}>Matching</option>
                    <option value="singleWord" ${type === 'singleWord' ? 'selected' : ''}>Single Word</option>
                  </select>
                </div>
                <!-- Add Section Button -->
                <button onclick="addSectionAfter('${id}')" 
                        class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition group" title="Add Section After">
                  <i class="fas fa-plus text-success text-sm"></i>
                </button>
                <button onclick="removeQuestionSection('${id}')" 
                          class="p-2 bg-danger/20 hover:bg-danger/30 rounded-lg transition group" title="Remove Section">
                    <i class="fas fa-trash text-danger text-sm"></i>
                </button>
                <!-- Action buttons -->
                <div class="flex gap-1">
                  <button onclick="moveQuestionUp('${id}')" 
                          class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition group" title="Move Up">
                    <i class="fas fa-arrow-up text-gray-400 group-hover:text-white text-sm"></i>
                  </button>
                  <button onclick="moveQuestionDown('${id}')" 
                          class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition group" title="Move Down">
                    <i class="fas fa-arrow-down text-gray-400 group-hover:text-white text-sm"></i>
                  </button>

                </div>
              </div>
            </div>
          </div>

          <!-- Question Body -->
          <div class="p-4 sm:p-6">
            <!-- Section Title and Marks - stacked on mobile, side-by-side on tablet+ -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
              <div class="flex-1">
                <label class="block text-sm font-semibold text-white mb-2">Section Title</label>
                <input type="text" class="section-title w-full bg-darkbg/50 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                      value="${title}" placeholder="Enter section title" oninput="saveCurrentState()">
              </div>
              <div class="w-full sm:w-32">
                <label class="block text-sm font-semibold text-white mb-2">Marks</label>
                <input type="number" class="section-marks w-full bg-darkbg/50 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                      value="${marks}" placeholder="0" min="0" oninput="saveCurrentState()">
              </div>
            </div>

            <!-- Questions Container (each sub-question will be spaced naturally) -->
            <div class="questions-container space-y-4 border border-gray-600 rounded-xl">
              ${questionContent}
            </div>

          </div>
        </div>
      </div>
    `;
  }
   
  
function getMCQTemplate(subQuestions) {
  if (!Array.isArray(subQuestions) || subQuestions.length === 0) {
    subQuestions = [{
      text: '',
      options: ['', '', '', '']
    }];
  }

  return subQuestions.map((sq, index) => `
    <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
      <div class="bg-darkbg/20 p-4 md:p-5 rounded-lg">
        <!-- Header: Question number, title, and action buttons -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 flex items-center justify-center bg-primary/20 rounded-lg flex-shrink-0 border border-primary/30">
              <span class="text-primary font-bold text-sm">${index + 1}</span>
            </div>
            <h4 class="text-white font-semibold">Question ${index + 1}</h4>
          </div>
          <div class="flex gap-2">
            <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addMCQQuestion(this)" title="Add another question">
              <i class="fas fa-plus text-success text-xs"></i>
            </button>
            <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeMCQQuestion(this)" title="Remove question">
              <i class="fas fa-minus text-danger text-xs"></i>
            </button>
          </div>
        </div>

        <!-- Question Textarea -->
        <div class="mb-4">
          <label class="block text-xs font-semibold text-gray-300 mb-2">Question Text</label>
          <textarea class="question-text w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition resize-none" placeholder="Enter your MCQ question..." oninput="autoResizeTextarea(this); saveCurrentState()" aria-label="Question ${index + 1}">${sq.text || ''}</textarea>
        </div>

        <!-- Options Grid -->
        <div class="space-y-2">
          <label class="block text-xs font-semibold text-gray-300">Options</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            ${['A', 'B', 'C', 'D'].map((letter, i) => `
              <div class="flex items-center gap-3 p-3 bg-darkbg/30 rounded-lg border border-gray-700 hover:border-gray-600 transition">
                <div class="w-8 h-8 flex items-center justify-center bg-primary/20 rounded border border-primary/30 flex-shrink-0">
                  <span class="text-primary font-bold text-xs">${letter}</span>
                </div>
                <input type="text" class="flex-1 bg-transparent text-white placeholder-gray-500 focus:outline-none" placeholder="Option ${letter}" value="${sq.options && sq.options[i] ? sq.options[i] : ''}" oninput="saveCurrentState()" aria-label="Question ${index + 1} option ${letter}" />
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

  function getQnATemplate(subQuestions) {
    if (subQuestions.length === 0) {
      subQuestions = [''];
    }

    return subQuestions.map((text, index) => `
      <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
        <div class="bg-darkbg/20 p-4 md:p-5">
          <!-- Header: Question number, title, and action buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 flex items-center justify-center bg-secondary/20 rounded-lg flex-shrink-0 border border-secondary/30">
                <span class="text-secondary font-bold text-sm">${index + 1}</span>
              </div>
              <h4 class="text-white font-semibold">Question ${index + 1}</h4>
            </div>
            <div class="flex gap-2">
              <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addQnAQuestion(this)" title="Add another question">
                <i class="fas fa-plus text-success text-xs"></i>
              </button>
              <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeQnAQuestion(this)" title="Remove question">
                <i class="fas fa-minus text-danger text-xs"></i>
              </button>
            </div>
          </div>

          <!-- Question Textarea -->
          <textarea class="question-text w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition resize-none" placeholder="Enter your question and answer..." oninput="autoResizeTextarea(this); saveCurrentState()">${text || ''}</textarea>
        </div>
      </div>
    `).join('');
  }

  function getFillUpTemplate(subQuestions) {
    if (subQuestions.length === 0) {
      subQuestions = [''];
    }

    return subQuestions.map((text, index) => `
      <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
        <div class="bg-darkbg/20 p-4 md:p-5">
          <!-- Header: Question number, title, and action buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 flex items-center justify-center bg-success/20 rounded-lg flex-shrink-0 border border-success/30">
                <span class="text-success font-bold text-sm">${index + 1}</span>
              </div>
              <h4 class="text-white font-semibold">Question ${index + 1}</h4>
            </div>
            <div class="flex gap-2">
              <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addFillUpQuestion(this)" title="Add another question">
                <i class="fas fa-plus text-success text-xs"></i>
              </button>
              <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeFillUpQuestion(this)" title="Remove question">
                <i class="fas fa-minus text-danger text-xs"></i>
              </button>
            </div>
          </div>

          <!-- Question Textarea -->
          <textarea class="question-text w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition resize-none" placeholder="Enter sentence with blank (use _____ for blank)..." oninput="autoResizeTextarea(this); saveCurrentState()">${text || ''}</textarea>
        </div>
      </div>
    `).join('');
  }

  function getTFTemplate(subQuestions) {
    if (subQuestions.length === 0) {
      subQuestions = [''];
    }

    return subQuestions.map((text, index) => `
      <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
        <div class="bg-darkbg/20 p-4 md:p-5">
          <!-- Header: Question number, title, and action buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 flex items-center justify-center bg-warning/20 rounded-lg flex-shrink-0 border border-warning/30">
                <span class="text-warning font-bold text-sm">${index + 1}</span>
              </div>
              <h4 class="text-white font-semibold">Question ${index + 1}</h4>
            </div>
            <div class="flex gap-2">
              <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addTFQuestion(this)" title="Add another question">
                <i class="fas fa-plus text-success text-xs"></i>
              </button>
              <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeTFQuestion(this)" title="Remove question">
                <i class="fas fa-minus text-danger text-xs"></i>
              </button>
            </div>
          </div>

          <!-- Question Textarea -->
          <textarea class="question-text w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition resize-none" placeholder="Enter true/false statement..." oninput="autoResizeTextarea(this); saveCurrentState()">${text || ''}</textarea>
        </div>
      </div>
    `).join('');
  }

  function getMatchTemplate(subQuestions, options) {
    if (subQuestions.length === 0) {
      subQuestions = [''];
      options = [''];
    }

    return subQuestions.map((left, index) => `
      <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
        <div class="bg-darkbg/20 p-4 md:p-5">
          <!-- Header: Question number, title, and action buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 flex items-center justify-center bg-purple-500/20 rounded-lg flex-shrink-0 border border-purple-500/30">
                <span class="text-purple-400 font-bold text-sm">${index + 1}</span>
              </div>
              <h4 class="text-white font-semibold">Pair ${index + 1}</h4>
            </div>
            <div class="flex gap-2">
              <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addMatchQuestion(this)" title="Add another pair">
                <i class="fas fa-plus text-success text-xs"></i>
              </button>
              <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeMatchQuestion(this)" title="Remove pair">
                <i class="fas fa-minus text-danger text-xs"></i>
              </button>
            </div>
          </div>

          <!-- Matching Inputs -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-gray-300 mb-2">Column A (Left)</label>
              <input type="text" class="match-left w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition" placeholder="Enter item from Column A" value="${left || ''}" oninput="saveCurrentState()">
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-300 mb-2">Column B (Right)</label>
              <input type="text" class="match-right w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition" placeholder="Enter matching item from Column B" value="${options[index] || ''}" oninput="saveCurrentState()">
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function getSingleWordTemplate(subQuestions) {
    if (subQuestions.length === 0) {
      subQuestions = [''];
    }

    return subQuestions.map((text, index) => `
      <div class="question-item border-b border-gray-700 last:border-b-0 pb-6">
        <div class="bg-darkbg/20 p-4 md:p-5">
          <!-- Header: Question number, title, and action buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 flex items-center justify-center bg-blue-500/20 rounded-lg flex-shrink-0 border border-blue-500/30">
                <span class="text-blue-400 font-bold text-sm">${index + 1}</span>
              </div>
              <h4 class="text-white font-semibold">Question ${index + 1}</h4>
            </div>
            <div class="flex gap-2">
              <button class="p-2 bg-success/20 hover:bg-success/30 border border-success/30 hover:border-success/50 rounded-lg transition" onclick="addSingleWordQuestion(this)" title="Add another question">
                <i class="fas fa-plus text-success text-xs"></i>
              </button>
              <button class="p-2 bg-danger/20 hover:bg-danger/30 border border-danger/30 hover:border-danger/50 rounded-lg transition" onclick="removeSingleWordQuestion(this)" title="Remove question">
                <i class="fas fa-minus text-danger text-xs"></i>
              </button>
            </div>
          </div>

          <!-- Question Textarea -->
          <textarea class="question-text w-full bg-darkbg/50 text-white border border-gray-700 hover:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition resize-none" placeholder="Enter the question (Answer should be a single word/term)..." oninput="autoResizeTextarea(this); saveCurrentState()">${text || ''}</textarea>
        </div>
      </div>
    `).join('');
  }

  // Question Management Functions
  function addQuestionType(type) {
    const container = document.getElementById('content');
    const questionData = {
      id: generateQuestionId(),
      type: type,
      qText: QUESTION_TYPE_LABELS[type] || 'Question Section',
      marks: '',
      subQuestion: type === 'match' ? [''] : type === 'mcq' ? [{ text: '', options: ['', '', '', ''] }] : ['']
    };

    if (type === 'match') {
      questionData.options = [''];
    }

    container.insertAdjacentHTML('beforeend', getQuestionTemplate(type, questionData));
    const newSection = container.lastElementChild;
    newSection.classList.add('fade-in');
    setTimeout(() => newSection.classList.remove('fade-in'), 400);

    // Update section numbers
    updateSectionNumbers();
    saveCurrentState();
  }

  function changeQuestionType(sectionId, newType) {
    const section = document.querySelector(`[data-id="${sectionId}"]`);
    if (!section) return;

    const oldType = section.dataset.type;
    if (oldType === newType) return;

    // Update section type
    section.dataset.type = newType;

    // Get current title and marks
    const titleInput = section.querySelector('.section-title');
    const marksInput = section.querySelector('.section-marks');
    
    // Update title to new type label
    const newTitle = QUESTION_TYPE_LABELS[newType] || 'Question Section';
    titleInput.value = newTitle;

    // Update header text - find h3 inside the section
    const headerText = section.querySelector('h3');
    const sectionNo = section.querySelector('.w-10.h-10 span').textContent;
    if (headerText) {
      headerText.innerHTML = `Section ${sectionNo}: ${newTitle}`;
    }

    // Update subtitle - find the p.text-gray-400 inside the header
    const subtitle = section.querySelector('.bg-gradient-to-r.from-primary\\/10 p.text-gray-400');
    if (subtitle) {
      subtitle.textContent = newTitle;
    }

    // Update select value
    const typeSelect = section.querySelector('.question-type-select');
    typeSelect.value = newType;

    // Get questions container
    const questionsContainer = section.querySelector('.questions-container');

    // Clear and add new template based on type
    let newContent = '';
    switch (newType) {
      case 'mcq':
        newContent = getMCQTemplate([{ text: '', options: ['', '', '', ''] }]);
        break;
      case 'QnA':
        newContent = getQnATemplate(['']);
        break;
      case 'fillUp':
        newContent = getFillUpTemplate(['']);
        break;
      case 'TF':
        newContent = getTFTemplate(['']);
        break;
      case 'match':
        newContent = getMatchTemplate([''], ['']);
        break;
      case 'singleWord':
        newContent = getSingleWordTemplate(['']);
        break;
    }

    questionsContainer.innerHTML = newContent;

    saveCurrentState();
    showToast(`Changed to ${newTitle}`, 'success');
  }

  function showQuestionTypeModal() {
    // Simple inline modal for question type selection
    const modalHTML = `
      <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-navbg border border-gray-700 rounded-2xl shadow-2xl max-w-2xl w-full transform transition-all duration-300">
          <div class="bg-gradient-to-r from-primary/20 to-secondary/20 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white flex items-center gap-3">
              <i class="fas fa-plus-circle text-primary"></i>
              Add Question Type
            </h2>
            <button onclick="document.querySelector('.question-type-modal').remove()" class="text-gray-400 hover:text-white transition">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <button onclick="addQuestionType('mcq'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-primary/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-list-ul text-primary text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">Multiple Choice</h4>
                <p class="text-gray-400 text-sm">MCQ Questions</p>
              </button>
              
              <button onclick="addQuestionType('QnA'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-secondary/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-question text-secondary text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">Q&A</h4>
                <p class="text-gray-400 text-sm">Question & Answer</p>
              </button>
              
              <button onclick="addQuestionType('fillUp'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-success/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-pencil-alt text-success text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">Fill in Blanks</h4>
                <p class="text-gray-400 text-sm">Fill in the blanks</p>
              </button>
              
              <button onclick="addQuestionType('TF'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-warning/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-check-double text-warning text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">True/False</h4>
                <p class="text-gray-400 text-sm">True or False statements</p>
              </button>
              
              <button onclick="addQuestionType('match'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-purple-500/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-exchange-alt text-purple-400 text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">Matching</h4>
                <p class="text-gray-400 text-sm">Match columns</p>
              </button>
              
              <button onclick="addQuestionType('singleWord'); document.querySelector('.question-type-modal').remove()" 
                      class="p-4 bg-darkbg/50 border border-gray-600 rounded-xl hover:border-primary transition group text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-blue-500/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fas fa-font text-blue-400 text-xl"></i>
                </div>
                <h4 class="font-semibold text-white mb-1">Single Word</h4>
                <p class="text-gray-400 text-sm">One word answers</p>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    const modalDiv = document.createElement('div');
    modalDiv.className = 'question-type-modal';
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
  }

  function removeQuestionSection(id) {
    const section = document.querySelector(`[data-id="${id}"]`);
    if (!section) return;

    const allSections = document.querySelectorAll('.question-section');
    if (allSections.length <= 1) {
      showToast('You must have at least one section', 'info');
      return;
    }

    if (confirm('Are you sure you want to remove this section?')) {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.remove();
        updateSectionNumbers();
        saveCurrentState();
        showToast('Section removed', 'success');
      }, 400);
    }
  }

  function moveQuestionUp(id) {
    const section = document.querySelector(`[data-id="${id}"]`);
    if (!section) return;

    const prevSection = section.previousElementSibling;
    if (!prevSection) return;

    section.classList.add('slide-move');
    prevSection.classList.add('slide-move');
    section.parentNode.insertBefore(section, prevSection);
    setTimeout(() => {
      section.classList.remove('slide-move');
      prevSection.classList.remove('slide-move');
    }, 300);
    updateSectionNumbers();
    saveCurrentState();
  }

  function moveQuestionDown(id) {
    const section = document.querySelector(`[data-id="${id}"]`);
    if (!section) return;

    const nextSection = section.nextElementSibling;
    if (!nextSection) return;

    section.classList.add('slide-move');
    nextSection.classList.add('slide-move');
    section.parentNode.insertBefore(nextSection, section);
    setTimeout(() => {
      section.classList.remove('slide-move');
      nextSection.classList.remove('slide-move');
    }, 300);
    updateSectionNumbers();
    saveCurrentState();
  }

  function addSectionAfter(id) {
    const currentSection = document.querySelector(`[data-id="${id}"]`);
    if (!currentSection) return;

    const newSectionHTML = getQuestionTemplate('mcq', {
      id: generateQuestionId(),
      type: 'mcq',
      qText: QUESTION_TYPE_LABELS['mcq'],
      marks: '',
      subQuestion: [{ text: '', options: ['', '', '', ''] }]
    });

    currentSection.insertAdjacentHTML('afterend', newSectionHTML);
    const newSection = currentSection.nextElementSibling;
    newSection.classList.add('fade-in');
    setTimeout(() => newSection.classList.remove('fade-in'), 400);
    updateSectionNumbers();
    saveCurrentState();
    showToast('New section added', 'success');
  }

  function updateSectionNumbers() {
    const sections = document.querySelectorAll('.question-section');
    sections.forEach((section, index) => {
      const questionNo = index + 1;
      const numberElement = section.querySelector('.w-10.h-10 span');
      const titleElement = section.querySelector('h3');
      const currentTitle = section.querySelector('.section-title').value;

      if (numberElement) {
        numberElement.textContent = questionNo;
      }

      if (titleElement) {
        titleElement.innerHTML = `Section ${questionNo}: ${currentTitle}`;
      }
    });

    sectionCounter = sections.length + 1;
  }

  // Question type specific functions
  function addMCQQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getMCQTemplate([{ text: '', options: ['', '', '', ''] }]));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeMCQQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function addQnAQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getQnATemplate(['']));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeQnAQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function addFillUpQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getFillUpTemplate(['']));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeFillUpQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function addTFQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getTFTemplate(['']));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeTFQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function addMatchQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getMatchTemplate([''], ['']));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeMatchQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function addSingleWordQuestion(button) {
    const currentQuestion = button.closest('.question-item');
    currentQuestion.insertAdjacentHTML('afterend', getSingleWordTemplate(['']));
    const newQuestion = currentQuestion.nextElementSibling;
    newQuestion.classList.add('fade-in');
    setTimeout(() => newQuestion.classList.remove('fade-in'), 400);
    const container = button.closest('.questions-container');
    updateQuestionNumbersInSection(container);
    saveCurrentState();
  }

  function removeSingleWordQuestion(button) {
    const questionItem = button.closest('.question-item');
    const container = button.closest('.questions-container');
    const questions = container.querySelectorAll('.question-item');

    if (questions.length <= 1) {
      showToast('You must have at least one question', 'info');
      return;
    }

    questionItem.classList.add('fade-out');
    setTimeout(() => {
      questionItem.remove();
      updateQuestionNumbersInSection(container);
      saveCurrentState();
    }, 400);
  }

  function updateQuestionNumbersInSection(container) {
    const questions = container.querySelectorAll('.question-item');
    questions.forEach((question, index) => {
      const numberElement = question.querySelector('.w-8.h-8 span');
      const h4Element = question.querySelector('h4');

      if (numberElement) {
        numberElement.textContent = index + 1;
      }

      if (h4Element) {
        h4Element.textContent = `Question ${index + 1}`;
      }
    });
  }

  function addQuestionToSection(id) {
    const section = document.querySelector(`[data-id="${id}"]`);
    if (!section) return;

    const type = section.dataset.type;
    const container = section.querySelector('.questions-container');

    switch (type) {
      case 'mcq':
        addMCQQuestion(container.querySelector('.question-item:last-child button'));
        break;
      case 'QnA':
        addQnAQuestion(container.querySelector('.question-item:last-child button'));
        break;
      case 'fillUp':
        addFillUpQuestion(container.querySelector('.question-item:last-child button'));
        break;
      case 'TF':
        addTFQuestion(container.querySelector('.question-item:last-child button'));
        break;
      case 'match':
        addMatchQuestion(container.querySelector('.question-item:last-child button'));
        break;
      case 'singleWord':
        addSingleWordQuestion(container.querySelector('.question-item:last-child button'));
        break;
    }
  }

  // State Management
  function saveCurrentState() {
    // Save metadata
    state.meta.event = document.getElementById('event').value || "";
    state.meta.subject = document.getElementById('subject').value || "";
    state.meta.std = document.getElementById('class').value || "";
    state.meta.hrs = document.getElementById('duration').value || "";
    state.meta.MM = document.getElementById('marks').value || "";
    state.meta.fontSize = document.getElementById('customRange').value || "20";

    // Save questions
    const sections = document.querySelectorAll('.question-section');
    state.questions = Array.from(sections).map(section => {
      const type = section.dataset.type;
      const qText = section.querySelector('.section-title').value || "";
      const marks = section.querySelector('.section-marks').value || "";
      const questionsContainer = section.querySelector('.questions-container');

      let subQuestion = [];
      let options = [];

      switch (type) {
        case 'mcq':
          subQuestion = Array.from(questionsContainer.querySelectorAll('.question-item')).map(item => ({
            text: item.querySelector('.question-text').value || "",
            options: Array.from(item.querySelectorAll('input[type="text"]')).map(input => input.value || "")
          }));
          break;
        case 'match':
          subQuestion = Array.from(questionsContainer.querySelectorAll('.match-left')).map(input => input.value || "");
          options = Array.from(questionsContainer.querySelectorAll('.match-right')).map(input => input.value || "");
          break;
        default:
          subQuestion = Array.from(questionsContainer.querySelectorAll('.question-text')).map(textarea => textarea.value || "");
      }

      return {
        type,
        qText,
        marks,
        subQuestion,
        ...(type === 'match' && { options })
      };
    });

    // Update UI
    updateStats();

    // Show save indicator
    showAutoSaveIndicator();
  }

  function updateStats() {
    const totalSections = state.questions.length;
    const totalQuestions = state.questions.reduce((total, q) => total + (q.subQuestion ? q.subQuestion.length : 0), 0);

    document.getElementById('totalSections').textContent = totalSections;
    document.getElementById('totalQuestions').textContent = totalQuestions;
  }

  async function autoSavePaper() {
    if (state.questions.length === 0) return;

    try {
      const response = await fetch(`/question-papers/api/${paperId}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: state.meta.event,
          subject: state.meta.subject,
          class_name: state.meta.std,
          marks: state.meta.MM,
          duration: state.meta.hrs,
          questions: state.questions
        })
      });

      const data = await response.json();
      if (data.success) {
        // Show auto-save success indicator
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.classList.remove('hidden');
        setTimeout(() => indicator.classList.add('hidden'), 2000);
      }
    } catch (error) {
      console.error('Auto-save failed:', error);
    }
  }

  // PDF Generation
  async function convertToPDF() {
    saveCurrentState();

    if (state.questions.length === 0) {
      showToast('Please add at least one question', 'error');
      return;
    }

    showLoading();

    try {
      const response = await fetch('/question_paper_api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          questions: state.questions,
          eventName: state.meta.event,
          subject: state.meta.subject,
          std: state.meta.std,
          hrs: state.meta.hrs,
          MM: state.meta.MM,
          fontSize: state.meta.fontSize
        })
      });

      if (!response.ok) throw new Error('API request failed');

      const data = await response.json();
      const html = data.html;


      const newWindow = window.open("", "_blank");
      newWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${state.meta.event} - Question Paper</title>
                <style>
                @page {
                    margin: 0px;
                    size: A4;
                }
                body {
                    margin: 0;
                    padding: 6px;
                    width: 210mm;
                    height: 297mm;
                    color: black;
                    background: rgb(255, 555, 255);
                    line-height: 1.2;
                }
                .content {
                    font-size: ${state.meta.fontSize}px;
                    margin-top:5px
                }
                .paperHeader {
                    font-size: 20px;
                }
                .question-block {
                    page-break-inside: avoid;
                    break-inside: avoid;
                }

                @media print {
                    body {
                        page-break-after: always;
                    }
                }
                </style>
        </head>
        <body>
          <div class="content">${html}</div>
          <script>
            window.onload = function() {
              // Auto-print after 1 second
              setTimeout(() => window.print(), 1000);
            };
          <\/script>
        </body>
        </html>
      `);
      newWindow.document.close();

      hideLoading();
      showToast('PDF generated successfully', 'success');
    } catch (error) {
      console.error('Error:', error);
      hideLoading();
      showToast('Error generating PDF. Please try again.', 'error');
    }
  }

  // Save Paper
  async function savePaper() {
    saveCurrentState();

    if (state.questions.length === 0) {
      showToast('Please add at least one question before saving', 'error');
      return;
    }

    const saveBtn = event?.target || document.querySelector('button[onclick="savePaper()"]');
    const originalHTML = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    try {
      const response = await fetch(`/question-papers/api/${paperId}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: state.meta.event,
          subject: state.meta.subject,
          class_name: state.meta.std,
          marks: state.meta.MM,
          duration: state.meta.hrs,
          questions: state.questions
        })
      });

      const data = await response.json();

      if (data.success) {
        showToast('Paper saved successfully!', 'success');
      } else {
        throw new Error(data.error || 'Unknown error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast(`Error: ${error.message}`, 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHTML;
    }
  }


  // Clear Paper
  function clearCurrentPaper() {
    if (!confirm("Are you sure? This will delete all questions in this paper.")) {
      return;
    }

    document.getElementById("content").innerHTML = '';
    state.questions = [];
    sectionCounter = 1;
    updateStats();

    // Add default section
    addQuestionType('mcq');
    showToast('All questions cleared', 'info');
  }

  // Render JSON data
  function renderJson(jsonData) {
    if (!jsonData) return;

    // Load metadata
    if (jsonData.meta) {
      document.getElementById("event").value = jsonData.meta.event || "";
      document.getElementById("subject").value = jsonData.meta.subject || "";
      document.getElementById("class").value = jsonData.meta.std || "";
      document.getElementById("duration").value = jsonData.meta.hrs || "";
      document.getElementById("marks").value = jsonData.meta.MM || "";
      document.getElementById("customRange").value = jsonData.meta.fontSize || "20";
      document.getElementById("fontSizeDisplay").textContent = (jsonData.meta.fontSize || "20") + "px";
    }

    // Reset section counter
    sectionCounter = 1;
    const container = document.getElementById("content");
    container.innerHTML = "";

    if (jsonData.questions && jsonData.questions.length > 0) {
      jsonData.questions.forEach((q) => {
        if (q.type) {
          container.insertAdjacentHTML('beforeend', getQuestionTemplate(q.type, q));
        }
      });
    } else {
      // Add default section if no questions
      addQuestionType('mcq');
    }

    saveCurrentState();
    updateStats();
  }

  // Initialize textarea autoresize
  document.addEventListener('input', function (e) {
    if (e.target.tagName === 'TEXTAREA') {
      autoResizeTextarea(e.target);
    }
  });
</script>

<style>

  textarea {
    resize: vertical;
    min-height: 60px;
    max-height: 300px;
  }

  /* Custom scrollbar */
  .questions-container::-webkit-scrollbar {
    width: 6px;
  }

  .questions-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }

  .questions-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  .questions-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Animation classes */
  .fade-in {
    opacity: 0;
    transform: translateY(-10px);
    animation: fadeInSlide 0.4s ease-out forwards;
  }

  .fade-out {
    animation: fadeOutSlide 0.4s ease-in forwards;
  }

  @keyframes fadeInSlide {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeOutSlide {
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .slide-move {
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
  }

</style>

{% endblock %}